<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KRSVFTQZK4"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-KRSVFTQZK4');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="favicon_io/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="favicon_io/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="favicon_io/favicon-16x16.png"><link rel="manifest" href="favicon_io/site.webmanifest">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon_io/apple-touch-icon.png">
    <title>Compare Products - Oda Pap</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="css/header.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header class="oda-header">
        <div class="header-top-bar">
            <div class="header-logo" onclick="location.href='index.html'">
                <img src="images/logo.png" alt="Oda Pap" class="header-logo-img">
                <span class="header-logo-text">Oda Pap</span>
            </div>
            <button onclick="window.history.back()" class="header-back-btn">
                <i class="fas fa-arrow-left"></i> Back
            </button>
        </div>
        <div class="header-divider"></div>
        <nav class="header-nav">
            <button class="header-nav-btn" onclick="location.href='index.html'"><i class="fas fa-home"></i></button>
            <button class="header-nav-btn" onclick="location.href='notification.html'"><i class="fas fa-bell"></i></button>
            <button class="header-nav-btn" onclick="location.href='cart.html'"><i class="fas fa-shopping-cart"></i></button>
            <button class="header-nav-btn" onclick="location.href='wishlist.html'"><i class="fas fa-heart"></i></button>
            <button class="header-nav-btn" onclick="location.href='profile.html'"><i class="fas fa-user-circle"></i></button>
        </nav>
    </header>

    <main>
        <div class="page-header">
            <h1><i class="fas fa-columns"></i> Compare Products</h1>
            <p>Side-by-side product comparison</p>
            <p style="font-size: 0.75rem; color: rgba(255,255,255,0.8); margin-top: 6px;">⚖️ Compare up to 4 products to find the best deal!</p>
        </div>

        <div class="cmp-container">
            <!-- Compare slots -->
            <div class="cmp-grid" id="compareGrid">
                <!-- Filled dynamically -->
            </div>

            <!-- Empty state -->
            <div id="emptyState" class="cmp-empty" style="display:none;">
                <i class="fas fa-balance-scale"></i>
                <h3>No products to compare</h3>
                <p>Add products from product pages using the <i class="fas fa-columns"></i> Compare button</p>
                <a href="index.html" class="cmp-btn-shop"><i class="fas fa-shopping-bag"></i> Browse Products</a>
            </div>

            <!-- Comparison Table (features) -->
            <div id="compareTable" class="cmp-table-wrap" style="display:none;">
                <h3><i class="fas fa-th-list"></i> Detailed Comparison</h3>
                <div class="cmp-table-scroll">
                    <table class="cmp-table" id="detailTable">
                        <!-- Filled dynamically -->
                    </table>
                </div>
            </div>

            <div class="cmp-actions" id="compareActions" style="display:none;">
                <button class="cmp-clear-btn" onclick="clearAll()">
                    <i class="fas fa-trash"></i> Clear All
                </button>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 Oda Pap Wholesale. All Rights Reserved.</p>
    </footer>

    <script type="module">
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { app } from "./js/firebase.js";
        import { showNotification } from './notifications.js';
        import { escapeHtml } from './js/sanitize.js';

        const db = getFirestore(app);
        const MAX_COMPARE = 4;

        function getCompareList() {
            return JSON.parse(localStorage.getItem('oda_compare') || '[]');
        }

        function saveCompareList(list) {
            localStorage.setItem('oda_compare', JSON.stringify(list));
            window.dispatchEvent(new Event('compare-updated'));
        }

        function getMinPrice(listing) {
            let minPrice = Infinity;
            let retailPrice = 0;
            if (listing.variations?.length) {
                listing.variations.forEach(v => {
                    if (v.tiers?.length) {
                        v.tiers.forEach(t => { if (t.price < minPrice) minPrice = t.price; });
                    }
                    if (v.retailPrice > retailPrice) retailPrice = v.retailPrice;
                });
            }
            if (minPrice === Infinity) minPrice = listing.price || 0;
            if (!retailPrice) retailPrice = listing.retailPrice || minPrice;
            return { price: minPrice, retailPrice };
        }

        async function loadCompareProducts() {
            const ids = getCompareList();
            const grid = document.getElementById('compareGrid');
            const empty = document.getElementById('emptyState');
            const table = document.getElementById('compareTable');
            const actions = document.getElementById('compareActions');

            if (ids.length === 0) {
                grid.innerHTML = '';
                empty.style.display = 'block';
                table.style.display = 'none';
                actions.style.display = 'none';
                return;
            }

            empty.style.display = 'none';
            actions.style.display = 'flex';
            grid.innerHTML = '<div class="cmp-loading"><i class="fas fa-spinner fa-spin"></i> Loading products...</div>';

            const products = [];
            for (const id of ids) {
                try {
                    const snap = await getDoc(doc(db, 'Listings', id));
                    if (snap.exists()) products.push({ id, ...snap.data() });
                } catch (e) { console.error('Error loading:', id, e); }
            }

            // Clean stale IDs
            if (products.length !== ids.length) {
                saveCompareList(products.map(p => p.id));
            }

            if (products.length === 0) {
                grid.innerHTML = '';
                empty.style.display = 'block';
                table.style.display = 'none';
                actions.style.display = 'none';
                return;
            }

            // Render product cards
            grid.innerHTML = products.map(p => {
                const { price, retailPrice } = getMinPrice(p);
                const img = p.photoTraceUrl || p.imageUrls?.[0] || 'images/product-placeholder.png';
                const margin = retailPrice > price ? Math.round(((retailPrice - price) / price) * 100) : 0;
                return `
                <div class="cmp-card">
                    <button class="cmp-remove" onclick="removeProduct('${p.id}')" title="Remove"><i class="fas fa-times"></i></button>
                    <div class="cmp-img" onclick="location.href='product.html?id=${p.id}'">
                        <img src="${img}" alt="${escapeHtml(p.name)}" loading="lazy">
                    </div>
                    <div class="cmp-info">
                        <h4>${escapeHtml(p.name)}</h4>
                        <p class="cmp-brand">${escapeHtml(p.brand || 'Unknown')}</p>
                        <p class="cmp-price">KES ${price.toLocaleString()}</p>
                        ${margin > 0 ? `<span class="cmp-margin">+${margin}% margin</span>` : ''}
                    </div>
                    <div class="cmp-card-actions">
                        <a href="product.html?id=${p.id}" class="cmp-view-btn"><i class="fas fa-eye"></i> View</a>
                    </div>
                </div>`;
            }).join('') + (products.length < MAX_COMPARE ? `
                <div class="cmp-card cmp-add-slot" onclick="location.href='index.html'">
                    <i class="fas fa-plus-circle"></i>
                    <p>Add Product</p>
                </div>` : '');

            // Build comparison table
            if (products.length >= 2) {
                table.style.display = 'block';
                const rows = [
                    { label: 'Price', key: p => `KES ${getMinPrice(p).price.toLocaleString()}` },
                    { label: 'Retail Price', key: p => `KES ${getMinPrice(p).retailPrice.toLocaleString()}` },
                    { label: 'Margin', key: p => { const m = getMinPrice(p); return m.retailPrice > m.price ? `+${Math.round(((m.retailPrice - m.price) / m.price) * 100)}%` : '-'; }},
                    { label: 'Brand', key: p => escapeHtml(p.brand || '-') },
                    { label: 'Category', key: p => escapeHtml(p.category || '-') },
                    { label: 'Subcategory', key: p => escapeHtml(p.subcategory || '-') },
                    { label: 'Condition', key: p => escapeHtml(p.condition || '-') },
                    { label: 'Variations', key: p => p.variations?.length ? `${p.variations.length} option(s)` : 'None' },
                    { label: 'Min Order', key: p => p.minOrder ? `${p.minOrder} pcs` : '1 pc' },
                    { label: 'Stock', key: p => p.stock != null ? (p.stock > 0 ? `${p.stock} available` : '<span style="color:#f44336">Out of stock</span>') : '-' },
                    { label: 'Seller', key: p => escapeHtml(p.sellerName || p.businessName || '-') },
                    { label: 'Location', key: p => escapeHtml([p.county, p.subcounty].filter(Boolean).join(', ') || '-') },
                ];

                const detailTable = document.getElementById('detailTable');
                detailTable.innerHTML = `
                    <thead>
                        <tr>
                            <th>Feature</th>
                            ${products.map(p => `<th>${escapeHtml(p.name?.substring(0, 30))}${p.name?.length > 30 ? '...' : ''}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${rows.map(row => `
                            <tr>
                                <td class="cmp-row-label">${row.label}</td>
                                ${products.map(p => `<td>${row.key(p)}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>`;
            } else {
                table.style.display = 'none';
            }
        }

        window.removeProduct = (id) => {
            let list = getCompareList().filter(i => i !== id);
            saveCompareList(list);
            loadCompareProducts();
            showNotification('Product removed from comparison');
        };

        window.clearAll = () => {
            if (!confirm('Clear all products from comparison?')) return;
            saveCompareList([]);
            loadCompareProducts();
            showNotification('Comparison cleared');
        };

        loadCompareProducts();

        // Listen for updates from other tabs
        window.addEventListener('storage', (e) => {
            if (e.key === 'oda_compare') loadCompareProducts();
        });
    </script>

    <style>
        .page-header {
            text-align: center; padding: 30px 20px;
            background: linear-gradient(135deg, #ff5722 0%, #ff7043 100%);
            color: white; margin-bottom: 24px;
        }
        .page-header h1 { margin: 0 0 8px; font-size: 24px; }
        .page-header p { margin: 0; opacity: 0.9; }

        .cmp-container { max-width: 1100px; margin: 0 auto; padding: 0 16px 60px; }

        .cmp-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 16px; margin-bottom: 24px;
        }

        .cmp-loading { grid-column: 1/-1; text-align: center; padding: 40px; color: #ff5722; font-size: 16px; }

        .cmp-card {
            background: white; border-radius: 12px; overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08); position: relative;
            display: flex; flex-direction: column; transition: all 0.2s;
        }
        .cmp-card:hover { box-shadow: 0 6px 20px rgba(0,0,0,0.12); transform: translateY(-2px); }

        .cmp-remove {
            position: absolute; top: 8px; right: 8px; z-index: 2;
            width: 28px; height: 28px; border-radius: 50%;
            background: rgba(0,0,0,0.6); color: white; border: none;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 12px; transition: background 0.2s;
        }
        .cmp-remove:hover { background: #f44336; }

        .cmp-img { height: 180px; overflow: hidden; background: #f5f5f5; cursor: pointer; }
        .cmp-img img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
        .cmp-card:hover .cmp-img img { transform: scale(1.05); }

        .cmp-info { padding: 14px; flex: 1; }
        .cmp-info h4 { margin: 0 0 4px; font-size: 14px; color: #222; line-height: 1.3; }
        .cmp-brand { margin: 0 0 6px; font-size: 12px; color: #888; }
        .cmp-price { margin: 0 0 4px; font-size: 18px; font-weight: 700; color: #ff5722; }
        .cmp-margin {
            display: inline-block; background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white; font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 600;
        }

        .cmp-card-actions { padding: 10px 14px; border-top: 1px solid #f0f0f0; }
        .cmp-view-btn {
            display: flex; align-items: center; justify-content: center; gap: 6px;
            width: 100%; padding: 8px; background: #ff5722; color: white;
            border-radius: 6px; text-decoration: none; font-size: 13px; font-weight: 600;
            transition: background 0.2s;
        }
        .cmp-view-btn:hover { background: #e64a19; }

        .cmp-add-slot {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 280px; border: 2px dashed #ddd; cursor: pointer; background: #fafafa;
        }
        .cmp-add-slot i { font-size: 36px; color: #ccc; margin-bottom: 8px; }
        .cmp-add-slot p { color: #999; font-size: 14px; }
        .cmp-add-slot:hover { border-color: #ff5722; background: #fff8f5; }
        .cmp-add-slot:hover i { color: #ff5722; }

        .cmp-empty { text-align: center; padding: 60px 20px; }
        .cmp-empty i { font-size: 56px; color: #ddd; margin-bottom: 16px; display: block; }
        .cmp-empty h3 { color: #444; margin: 0 0 8px; }
        .cmp-empty p { color: #888; margin: 0 0 20px; font-size: 14px; }
        .cmp-btn-shop {
            display: inline-flex; align-items: center; gap: 6px; padding: 12px 24px;
            background: #ff5722; color: white; border-radius: 8px; text-decoration: none;
            font-weight: 600; transition: all 0.2s;
        }
        .cmp-btn-shop:hover { background: #e64a19; transform: translateY(-1px); }

        /* Table */
        .cmp-table-wrap {
            background: white; border-radius: 12px; padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 20px;
        }
        .cmp-table-wrap h3 { margin: 0 0 16px; font-size: 16px; color: #333; }
        .cmp-table-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }

        .cmp-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .cmp-table th, .cmp-table td { padding: 10px 14px; text-align: left; border-bottom: 1px solid #f0f0f0; }
        .cmp-table thead th { background: #fafafa; font-weight: 700; color: #333; font-size: 12px; white-space: nowrap; position: sticky; top: 0; }
        .cmp-table .cmp-row-label { font-weight: 600; color: #555; white-space: nowrap; min-width: 100px; }
        .cmp-table tbody tr:hover { background: #fff8f5; }

        .cmp-actions { display: flex; justify-content: center; }
        .cmp-clear-btn {
            background: #f44336; color: white; border: none; padding: 10px 24px;
            border-radius: 8px; font-size: 13px; cursor: pointer; display: flex;
            align-items: center; gap: 6px; transition: all 0.2s;
        }
        .cmp-clear-btn:hover { background: #d32f2f; }

        @media (max-width: 600px) {
            .cmp-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .cmp-img { height: 140px; }
            .cmp-table { font-size: 12px; }
            .cmp-table th, .cmp-table td { padding: 8px 10px; }
        }
    </style>
</body>
</html>
