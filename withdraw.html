<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="favicon_io/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="favicon_io/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="favicon_io/favicon-16x16.png"><link rel="manifest" href="favicon_io/site.webmanifest">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon_io/apple-touch-icon.png">
    <title>Withdraw - Oda Pap</title>
    <link rel="stylesheet" href="withdraw.css">
    <link rel="stylesheet" href="css/header.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>
<body>
    <header class="oda-header">
        <div class="header-top-bar">
            <div class="header-logo" onclick="location.href='index.html'">
                <img src="images/logo.png" alt="Oda Pap" class="header-logo-img">
                <span class="header-logo-text">Oda Pap</span>
            </div>
            <button onclick="window.history.back()" class="header-back-btn">
                <i class="fas fa-arrow-left"></i> Back
            </button>
        </div>
        <div class="header-divider"></div>
        <nav class="header-nav">
            <button class="header-nav-btn" onclick="location.href='index.html'"><i class="fas fa-home"></i></button>
            <button class="header-nav-btn" onclick="location.href='profile.html'"><i class="fas fa-user-circle"></i></button>
        </nav>
    </header>
    <main>
        <div class="withdraw-hero">
            <h1><i class="fas fa-money-bill-wave"></i> Withdraw Funds</h1>
            <p>Send wallet balance to your M-Pesa</p>
            <span class="hero-note">ðŸ’° Withdrawals are processed manually within 24 hours</span>
        </div>

        <div class="withdraw-content">
            <!-- Balance Card -->
            <div class="balance-card">
                <div class="balance-icon"><i class="fas fa-wallet"></i></div>
                <div>
                    <div class="balance-label">Available Balance</div>
                    <div class="balance-value" id="currentBalance">KES 0</div>
                </div>
            </div>

            <!-- Form -->
            <div class="withdraw-form-card">
                <h3><i class="fas fa-paper-plane"></i> Request Withdrawal</h3>
                <form id="withdraw-form">
                    <div class="form-group">
                        <label for="withdraw-amount"><i class="fas fa-money-bill-wave"></i> Amount (KES)</label>
                        <input type="number" id="withdraw-amount" name="withdraw-amount" min="1" max="150000" placeholder="Enter amount" required>
                        <small class="field-hint" id="withdrawMinHint">Minimum: KES 1 Â· Maximum: KES 150,000</small>
                        <div class="quick-amounts">
                            <button type="button" class="quick-amount-chip" data-amount="500">500</button>
                            <button type="button" class="quick-amount-chip" data-amount="1000">1,000</button>
                            <button type="button" class="quick-amount-chip" data-amount="2000">2,000</button>
                            <button type="button" class="quick-amount-chip" data-amount="5000">5,000</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="withdraw-phone"><i class="fas fa-mobile-alt"></i> M-Pesa Number</label>
                        <input type="tel" id="withdraw-phone" placeholder="e.g. 0712345678" maxlength="13" required>
                        <small class="field-hint">Safaricom number to receive funds</small>
                    </div>
                    <button type="submit" class="btn-withdraw" id="withdrawBtn">
                        <i class="fas fa-paper-plane"></i> Submit Withdrawal Request
                    </button>
                    <p class="form-footer-note">
                        <i class="fas fa-shield-alt"></i> Requests are reviewed &amp; processed within 24 hours
                    </p>
                </form>
            </div>

            <!-- History -->
            <div class="history-card">
                <div class="history-card-header">
                    <i class="fas fa-history"></i>
                    <h3>Recent Withdrawals</h3>
                </div>
                <div class="history-list" id="withdrawalsList">
                    <div class="history-empty">
                        <i class="fas fa-receipt"></i>
                        <p>No withdrawal history yet</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="withdraw-footer">
        <p>&copy; 2026 Oda Pap. All Rights Reserved.</p>
    </footer>

    <script type="module">
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, query, where, orderBy, limit, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { app } from './js/firebase.js';

        const auth = getAuth(app);
        const db = getFirestore(app);
        let userData = null;

        function showToast(msg, type = 'success') {
            const t = document.createElement('div');
            t.className = `toast-withdraw ${type}`;
            t.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : 'exclamation-triangle'}"></i> ${msg}`;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3500);
        }

        // Quick amount chips
        document.querySelectorAll('.quick-amount-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                document.getElementById('withdraw-amount').value = chip.dataset.amount;
                document.querySelectorAll('.quick-amount-chip').forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
            });
        });

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'login.html?redirect=withdraw.html';
                return;
            }
            try {
                const userDoc = await getDoc(doc(db, 'Users', user.uid));
                if (userDoc.exists()) {
                    userData = userDoc.data();
                    const bal = userData.walletBalance || 0;
                    document.getElementById('currentBalance').textContent = `KES ${bal.toLocaleString()}`;
                    
                    // Prefill phone
                    const phone = userData.phone || '';
                    if (phone) document.getElementById('withdraw-phone').value = phone;
                }
                // Load recent withdrawals
                await loadWithdrawals(user.uid);
            } catch (err) {
                console.error('Error loading user data:', err);
            }
        });

        async function loadWithdrawals(userId) {
            try {
                const q = query(
                    collection(db, 'users', userId, 'walletTransactions'),
                    where('type', '==', 'withdrawal'),
                    orderBy('createdAt', 'desc'),
                    limit(10)
                );
                const snap = await getDocs(q);
                if (snap.empty) return;
                
                const listEl = document.getElementById('withdrawalsList');
                listEl.innerHTML = snap.docs.map(d => {
                    const data = d.data();
                    const date = data.createdAt?.toDate?.() || new Date();
                    const status = data.status || 'pending';
                    return `<div class="history-item">
                        <div>
                            <div class="history-amount">KES ${(data.amount || 0).toLocaleString()}</div>
                            <div class="history-date">${date.toLocaleDateString('en-KE',{day:'numeric',month:'short',year:'numeric'})}</div>
                        </div>
                        <span class="status-badge ${status}">${status}</span>
                    </div>`;
                }).join('');
            } catch (err) {
                console.error('Error loading withdrawals:', err);
            }
        }

        document.getElementById('withdraw-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;

            const amountInput = document.getElementById('withdraw-amount');
            const phoneInput = document.getElementById('withdraw-phone');
            const btn = document.getElementById('withdrawBtn');
            const amount = parseInt(amountInput.value);
            let phone = phoneInput.value.replace(/\D/g, '');

            // Validate amount â€” minimum KES 1
            if (!amount || amount < 1) {
                showToast('Please enter a valid amount', 'warning');
                return;
            }
            if (amount > 150000) {
                showToast('Maximum withdrawal is KES 150,000', 'warning');
                return;
            }
            const balance = userData?.walletBalance || 0;
            if (amount > balance) {
                showToast('Insufficient balance', 'error');
                return;
            }

            // Validate phone
            if (phone.startsWith('254')) phone = '0' + phone.substring(3);
            if (!/^0[17]\d{8}$/.test(phone)) {
                showToast('Please enter a valid Safaricom phone number', 'error');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

            try {
                await addDoc(collection(db, 'WithdrawalRequests'), {
                    userId: user.uid,
                    userEmail: user.email,
                    userName: userData?.name || 'Unknown',
                    amount: amount,
                    phone: phone,
                    status: 'pending',
                    createdAt: serverTimestamp()
                });

                showToast('Request submitted! Funds sent within 24 hours.', 'success');
                amountInput.value = '';
                document.querySelectorAll('.quick-amount-chip').forEach(c => c.classList.remove('active'));
                await loadWithdrawals(user.uid);
            } catch (err) {
                console.error('Withdrawal error:', err);
                showToast('Failed to submit request. Please try again.', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Withdrawal Request';
            }
        });
    </script>
</body>
</html>
