<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KRSVFTQZK4"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-KRSVFTQZK4');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content">
    <link rel="icon" type="image/x-icon" href="favicon_io/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="favicon_io/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="favicon_io/favicon-16x16.png"><link rel="manifest" href="favicon_io/site.webmanifest">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon_io/apple-touch-icon.png">
    <title>Search Results - Oda Pap</title>
    <link rel="stylesheet" href="search.css">
    <link rel="stylesheet" href="css/dynamicSearch.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>
<body>
    <!-- Sticky Search Header -->
    <header class="search-header">
        <button class="search-back-btn" onclick="window.history.back()">
            <i class="fas fa-arrow-left"></i>
        </button>
        <div class="search-bar-wrap">
            <form id="searchForm" action="search-results.html" method="GET" autocomplete="off">
                <i class="fas fa-search search-icon"></i>
                <input type="text" name="q" id="searchInput" placeholder="Search products, brands..." autocomplete="off">
                <button type="button" class="search-clear-btn" id="clearBtn" style="display:none;">
                    <i class="fas fa-times"></i>
                </button>
            </form>
        </div>
    </header>

    <main class="search-page">
        <!-- Sort / Filter Chips -->
        <div class="search-toolbar" id="searchToolbar" style="display:none;">
            <div class="search-result-info">
                <span id="resultCount">0</span> results for "<span id="searchQuery"></span>"
            </div>
            <div class="search-sort">
                <button class="sort-chip active" data-sort="relevant"><i class="fas fa-star"></i> Best Match</button>
                <button class="sort-chip" data-sort="price-low"><i class="fas fa-sort-amount-down-alt"></i> Price Low</button>
                <button class="sort-chip" data-sort="price-high"><i class="fas fa-sort-amount-up"></i> Price High</button>
            </div>
        </div>

        <!-- Loading Skeletons -->
        <div id="loadingState" class="search-loading">
            <div class="loading-grid">
                <div class="skeleton-card"><div class="skeleton-img"></div><div class="skeleton-text"></div><div class="skeleton-text short"></div></div>
                <div class="skeleton-card"><div class="skeleton-img"></div><div class="skeleton-text"></div><div class="skeleton-text short"></div></div>
                <div class="skeleton-card"><div class="skeleton-img"></div><div class="skeleton-text"></div><div class="skeleton-text short"></div></div>
                <div class="skeleton-card"><div class="skeleton-img"></div><div class="skeleton-text"></div><div class="skeleton-text short"></div></div>
                <div class="skeleton-card"><div class="skeleton-img"></div><div class="skeleton-text"></div><div class="skeleton-text short"></div></div>
                <div class="skeleton-card"><div class="skeleton-img"></div><div class="skeleton-text"></div><div class="skeleton-text short"></div></div>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorState" class="search-state-msg" style="display:none;">
            <div class="state-icon error"><i class="fas fa-exclamation-triangle"></i></div>
            <h3>Something went wrong</h3>
            <p id="errorMessage">Please try again</p>
            <button onclick="location.reload()" class="state-btn"><i class="fas fa-redo"></i> Retry</button>
        </div>

        <!-- Empty / No Results State -->
        <div id="emptyState" class="search-state-msg" style="display:none;">
            <div class="state-icon empty">üîç</div>
            <h3>No results found</h3>
            <p>We couldn't find anything matching your search.</p>
            <div class="empty-tips">
                <span>Try:</span> different keywords ¬∑ shorter terms ¬∑ checking spelling
            </div>
            <a href="index.html" class="state-btn"><i class="fas fa-home"></i> Browse Products</a>
        </div>

        <!-- Results Grid -->
        <div class="search-results-grid" id="searchResults"></div>
    </main>

    <script type="module">
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { app } from "./js/firebase.js";
        import { setupGlobalImageErrorHandler, getImageUrl, initLazyLoading } from './js/imageCache.js';
        import { initDynamicSearch } from './js/dynamicSearch.js';
        
        const db = getFirestore(app);
        setupGlobalImageErrorHandler();

        const searchInput = document.getElementById('searchInput');
        const clearBtn = document.getElementById('clearBtn');
        let allResults = [];

        // Init dynamic search suggestions on this page's search bar
        initDynamicSearch('searchInput');

        // Clear button logic
        searchInput.addEventListener('input', () => {
            clearBtn.style.display = searchInput.value.trim() ? 'flex' : 'none';
        });
        clearBtn.addEventListener('click', () => {
            searchInput.value = '';
            clearBtn.style.display = 'none';
            searchInput.focus();
        });

        // Min price helper
        function getMinPrice(product) {
            if (product.variations?.length > 0) {
                let min = Infinity;
                product.variations.forEach(v => {
                    v.attributes?.forEach(a => {
                        const p = a.originalPrice || a.price || 0;
                        if (p > 0 && p < min) min = p;
                    });
                });
                return min === Infinity ? (product.originalPrice || product.price || 0) : min;
            }
            return product.originalPrice || product.price || 0;
        }

        // Sort chip buttons
        document.querySelectorAll('.sort-chip').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.sort-chip').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                sortAndDisplay(btn.dataset.sort);
            });
        });

        function sortAndDisplay(sortType) {
            let sorted = [...allResults];
            if (sortType === 'price-low') sorted.sort((a, b) => getMinPrice(a) - getMinPrice(b));
            else if (sortType === 'price-high') sorted.sort((a, b) => getMinPrice(b) - getMinPrice(a));
            else sorted.sort((a, b) => b.score - a.score);
            renderResults(sorted);
        }

        async function performSearch() {
            const urlParams = new URLSearchParams(window.location.search);
            const searchQuery = urlParams.get('q')?.trim();
            
            document.getElementById('searchQuery').textContent = searchQuery || '';
            if (searchQuery) {
                searchInput.value = searchQuery;
                clearBtn.style.display = 'flex';
            }

            if (!searchQuery) {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('emptyState').style.display = 'flex';
                return;
            }

            try {
                const querySnapshot = await getDocs(collection(db, "Listings"));
                const searchLower = searchQuery.toLowerCase();
                const searchTerms = searchLower.split(/\s+/);
                
                const results = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const name = (data.name || '').toLowerCase();
                    const brand = (data.brand || '').toLowerCase();
                    const description = (data.description || '').toLowerCase();
                    const category = (data.category || '').toLowerCase();
                    
                    const matches = searchTerms.some(term => 
                        name.includes(term) || 
                        brand.includes(term) || 
                        description.includes(term) ||
                        category.includes(term)
                    );
                    
                    if (matches) {
                        let score = 0;
                        searchTerms.forEach(term => {
                            if (name.includes(term)) score += 10;
                            if (name.startsWith(term)) score += 5;
                            if (brand.includes(term)) score += 3;
                            if (category.includes(term)) score += 2;
                        });
                        results.push({ id: doc.id, ...data, score });
                    }
                });
                
                results.sort((a, b) => b.score - a.score);
                allResults = results;
                displayResults(results);
            } catch (error) {
                console.error("Search error:", error);
                showError("Error performing search. Please try again.");
            }
        }

        function displayResults(results) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('resultCount').textContent = results.length;

            if (results.length === 0) {
                document.getElementById('emptyState').style.display = 'flex';
                document.getElementById('searchToolbar').style.display = 'none';
                return;
            }

            document.getElementById('searchToolbar').style.display = 'block';
            renderResults(results);
        }

        function renderResults(results) {
            const container = document.getElementById('searchResults');
            container.innerHTML = results.map((product, i) => {
                const price = getMinPrice(product);
                const imageUrl = getImageUrl(product.imageUrls?.[0], 'product');
                const variantCount = countVariants(product);
                
                return `
                    <a href="product.html?id=${product.id}" class="result-card" style="animation-delay:${Math.min(i * 0.03, 0.3)}s">
                        <div class="result-img">
                            <img src="${imageUrl}" alt="${product.name}" loading="lazy" data-fallback="product">
                            ${product.brand ? `<span class="result-brand">${product.brand}</span>` : ''}
                        </div>
                        <div class="result-info">
                            <h3 class="result-name">${product.name}</h3>
                            <p class="result-price">KES ${price.toLocaleString()}</p>
                            ${variantCount > 0 ? `<span class="result-variants">${variantCount} options</span>` : ''}
                        </div>
                    </a>
                `;
            }).join('');
            
            initLazyLoading();
        }
        
        function countVariants(product) {
            let count = 0;
            product.variations?.forEach(v => { count += v.attributes?.length || 0; });
            return count;
        }

        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'flex';
            document.getElementById('errorMessage').textContent = message;
        }

        document.addEventListener('DOMContentLoaded', performSearch);
    </script>
</body>
</html>
