<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/jpeg" href="images/logo.png">
    <link rel="apple-touch-icon" href="images/logo.png">
    <title>Search Results - Oda Pap</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="search.css">
    <link rel="stylesheet" href="css/header.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>
<body>
    <header class="oda-header">
        <div class="header-top-bar">
            <div class="header-logo" onclick="location.href='index.html'">
                <img src="images/logo.png" alt="Oda Pap" class="header-logo-img">
                <span class="header-logo-text">Oda Pap</span>
            </div>
            <div class="header-search">
                <form id="searchForm" action="search-results.html" method="GET">
                    <input type="text" name="q" id="searchInput" placeholder="Search products..." autocomplete="off">
                    <button type="submit"><i class="fas fa-search"></i></button>
                </form>
            </div>
            <button onclick="window.history.back()" class="header-back-btn">
                <i class="fas fa-arrow-left"></i> Back
            </button>
        </div>
        <div class="header-divider"></div>
        <nav class="header-nav">
            <button class="header-nav-btn" onclick="location.href='index.html'"><i class="fas fa-home"></i></button>
            <button class="header-nav-btn" onclick="location.href='notification.html'"><i class="fas fa-bell"></i><span class="header-nav-counter" id="notification-count"></span></button>
            <button class="header-nav-btn" onclick="location.href='cart.html'"><i class="fas fa-shopping-cart"></i><span class="header-nav-counter" id="cart-count"></span></button>
            <button class="header-nav-btn" onclick="location.href='wishlist.html'"><i class="fas fa-heart"></i><span class="header-nav-counter" id="wishlist-count"></span></button>
            <button class="header-nav-btn" onclick="location.href='profile.html'"><i class="fas fa-user-circle"></i></button>
        </nav>
    </header>

    <main class="search-results-page">
        <div id="loadingSpinner">Loading...</div>
        <div id="errorMessage" style="display: none; color: red;"></div>

        <div class="search-results-container">
            <div class="search-summary">
                <h2>Search Results for "<span id="searchQuery"></span>"</h2>
                <p><span id="resultCount">0</span> items found</p>
            </div>

            <div class="results-grid" id="searchResults"></div>
        </div>
    </main>

    <script type="module">
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { app } from "./js/firebase.js";
        import { showNotification } from './notifications.js';
        
        const db = getFirestore(app);

        // Get min price from variations
        function getMinPrice(product) {
            if (product.variations?.length > 0) {
                let min = Infinity;
                product.variations.forEach(v => {
                    v.attributes?.forEach(a => {
                        const p = a.originalPrice || a.price || 0;
                        if (p > 0 && p < min) min = p;
                    });
                });
                return min === Infinity ? (product.originalPrice || product.price || 0) : min;
            }
            return product.originalPrice || product.price || 0;
        }

        async function performSearch() {
            const urlParams = new URLSearchParams(window.location.search);
            const searchQuery = urlParams.get('q')?.trim();
            
            document.getElementById('searchQuery').textContent = searchQuery || '';

            if (!searchQuery) {
                showError("No search query specified");
                return;
            }

            try {
                // Get all listings and filter client-side for better search
                const querySnapshot = await getDocs(collection(db, "Listings"));
                const searchLower = searchQuery.toLowerCase();
                const searchTerms = searchLower.split(/\s+/);
                
                const results = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const name = (data.name || '').toLowerCase();
                    const brand = (data.brand || '').toLowerCase();
                    const description = (data.description || '').toLowerCase();
                    const category = (data.category || '').toLowerCase();
                    
                    // Check if any search term matches
                    const matches = searchTerms.some(term => 
                        name.includes(term) || 
                        brand.includes(term) || 
                        description.includes(term) ||
                        category.includes(term)
                    );
                    
                    if (matches) {
                        // Score results by relevance
                        let score = 0;
                        searchTerms.forEach(term => {
                            if (name.includes(term)) score += 10;
                            if (name.startsWith(term)) score += 5;
                            if (brand.includes(term)) score += 3;
                            if (category.includes(term)) score += 2;
                        });
                        
                        results.push({ id: doc.id, ...data, score });
                    }
                });
                
                // Sort by relevance
                results.sort((a, b) => b.score - a.score);
                
                displayResults(results);
            } catch (error) {
                console.error("Search error:", error);
                showError("Error performing search. Please try again.");
            }
        }

        function displayResults(results) {
            const resultsContainer = document.getElementById('searchResults');
            const resultCount = document.getElementById('resultCount');
            
            document.getElementById('loadingSpinner').style.display = 'none';
            resultCount.textContent = results.length;

            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-search"></i>
                        <p>No products found</p>
                        <small>Try different keywords or browse categories</small>
                        <a href="index.html" class="btn-browse">Browse Products</a>
                    </div>
                `;
                return;
            }

            resultsContainer.innerHTML = results.map(product => {
                const price = getMinPrice(product);
                const imageUrl = product.imageUrls?.[0] || 'images/product-placeholder.png';
                
                return `
                    <div class="product-card" onclick="window.location.href='product.html?id=${product.id}'">
                        <div class="product-image">
                            <img src="${imageUrl}" alt="${product.name}" loading="lazy">
                            ${product.brand ? `<span class="product-brand">${product.brand}</span>` : ''}
                        </div>
                        <div class="product-info">
                            <h3>${product.name}</h3>
                            <p class="price">KES ${price.toLocaleString()}</p>
                            ${product.variations?.length > 0 ? `<span class="variants-count">${countVariants(product)} options</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function countVariants(product) {
            let count = 0;
            product.variations?.forEach(v => {
                count += v.attributes?.length || 0;
            });
            return count;
        }

        function showError(message) {
            document.getElementById('loadingSpinner').style.display = 'none';
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        // Perform search when page loads
        document.addEventListener('DOMContentLoaded', performSearch);
    </script>
</body>
</html>