<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/jpeg" href="images/logo.jpg">
    <link rel="apple-touch-icon" href="images/logo.jpg">
    <title>Profile - Oda Pap</title>
    <link rel="stylesheet" href="profile.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
  </head>
  <body>
    <header>
      <h1>Profile</h1>
      <div class="nav-bar" id="nav-bar">
        <button class="home-button" onclick="location.href='index.html'">
          <i class="fas fa-home"></i>
        </button>

        <button class="home-button" onclick="location.href='notification.html'">
          <i class="fas fa-bell" id="notification-icon"></i>
        </button>
        <button class="home-button" onclick="location.href='cart.html'">
          <i class="fas fa-shopping-cart" id="cart-icon"></i>
        </button>
        <button class="home-button" onclick="location.href='profile.html'" style="position: relative;">
          <i class="fas fa-user-circle"></i>
          <span id="profile-notification" class="blinking-notification" style="display: none;"></span>
        </button>
      </div>
    </header>

    <main>
      <div class="profile-container">
        <h2>Your Profile</h2>
        <div id="profile-details" class="profile-details">
          <img
            src="images/profile-placeholder.png"
            alt="Profile Picture"
            id="profile-pic"
            class="profile-pic"
          />
          <input
            type="file"
            id="profile-pic-input"
            accept="image/*"
            style="display: none"
          />
          <button id="change-pic-button">Change Picture</button>

          <p><strong>Email:</strong> <span id="user-email"></span></p>
          <p>
            <strong>Name:</strong> <span id="user-name"></span>
            <button id="edit-name-button" onclick="showEditName()">Edit Name</button>
          </p>
          <div id="edit-name-container" style="display: none">
            <input
              type="text"
              id="new-name-input"
              placeholder="Enter new name"
            />
            <button id="save-name-button">Save</button>
            <button id="cancel-name-button" onclick="hideEditName()">Cancel</button>
          </div>

          <p>
            <strong>Phone:</strong> <span id="user-phone"></span>
            <button id="edit-phone-button" onclick="showEditPhone()">Edit Phone</button>
          </p>
          <div id="edit-phone-container" style="display: none">
            <input
              type="text"
              id="new-phone-input"
              placeholder="Enter your phone number"
            />
            <button id="save-phone-button">Save</button>
            <button id="cancel-phone-button" onclick="hideEditPhone()">Cancel</button>
          </div>

          <p><strong>Location:</strong></p>
          <p>
            <span><strong>Region:</strong> <span id="user-region"></span></span><br />
            <span><strong>County:</strong> <span id="user-county"></span></span><br />
            <span><strong>Constituency:</strong> <span id="user-constituency"></span></span><br />
            <span><strong>Ward:</strong> <span id="user-ward"></span></span><br />
            <span><strong>Specific Location:</strong> <span id="user-specific-location"></span></span>
            <button id="edit-location-button" onclick="showEditLocation()">Edit Location</button>
          </p>
          
<div class = "location-selection" id="location-selection" style="display: none;">
          <label for="region-select">Region:</label>
          <select id="region-select">
            <option value="" disabled selected>Select Region</option>
            <option value="coast">Coast</option>
            <option value="north-eastern">North Eastern</option>
            <option value="eastern">Eastern</option>
            <option value="central">Central</option>
            <option value="rift-valley">Rift Valley</option>
            <option value="western">Western</option>
            <option value="nyanza">Nyanza</option>
            <option value="nairobi">Nairobi</option>
          </select>

          <!-- County dropdown -->
          <label for="county-select">County:</label>
          <select id="county-select" disabled>
            <option value="" disabled selected>Select County</option>
          </select>

          <!-- Constituency dropdown -->
          <label for="constituency-select">Constituency:</label>
          <select id="constituency-select" disabled>
            <option value="" disabled selected>Select Constituency</option>
          </select>

          <!-- Ward dropdown -->
          <label for="ward-select">Ward:</label>
          <select id="ward-select" disabled>
            <option value="" disabled selected>Select Ward</option>
          </select>

          <!-- Specific details -->
          <label for="specific-details">Specific Location Details:</label>
          <textarea
            id="specific-details"
            placeholder="Enter specific details about your location"
          ></textarea>
          <button id="save-location-button">Save Location</button>
          
        </div>
      </div>
    </div>
      <section class="account-balance">
        <h3>Account Balance</h3>
        <p>KES<span id="account-balance">XXXX</span></p>
        <button id="toggle-balance"><i class="fas fa-eye"></i></button>
      </section>

      <div class="border-line"></div>

      <section class="account-info">
        <a href="deposit.html" class="account-option">
          <i class="fas fa-money-check-alt"></i>
          <span>Deposit</span>
        </a>
        <a href="withdraw.html" class="account-option">
          <i class="fas fa-money-bill-wave"></i>
          <span>Withdraw</span>
        </a>
        <a href="customer_care.html" class="account-option">
          <i class="fas fa-headset"></i>
          <span>Customer Care</span>
        </a>
        <a href="cart.html" class="account-option">
          <i class="fas fa-shopping-cart"></i>
          <span>Cart</span>
        </a>
        <a href="user.html" class="account-option">
          <i class="fas fa-user-circle"></i>
          <span>Seller Details</span>
        </a>
        <a href="recently_viewed.html" class="account-option">
          <i class="fas fa-history"></i>
          <span>Recently Viewed</span>
        </a>
        <a href="listing.html" class="account-option">
          <i class="fas fa-plus"></i>
          <span>Listing Page (SELL)</span>
        </a>
      </section>
    </main>

    <footer>
      <div class="footer-content">
        <h3>Follow Us</h3>
        <ul class="socials">
          <li>
            <a href="https://www.facebook.com/yourprofile" target="_blank"
              ><i class="fab fa-facebook-f"></i
            ></a>
          </li>
          <li>
            <a href="https://www.twitter.com/yourprofile" target="_blank"
              ><i class="fab fa-twitter"></i
            ></a>
          </li>
          <li>
            <a href="https://www.instagram.com/yourprofile" target="_blank"
              ><i class="fab fa-instagram"></i
            ></a>
          </li>
          <li>
            <a href="https://www.linkedin.com/in/yourprofile" target="_blank"
              ><i class="fab fa-linkedin-in"></i
            ></a>
          </li>
        </ul>
      </div>
    </footer>

    <script type="module">
      import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
      import { getFirestore, doc, updateDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
      import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-storage.js";
      import { app } from "./js/firebase.js";
      import { showNotification } from './notifications.js';

      const auth = getAuth(app);
      const db = getFirestore(app);
      const storage = getStorage(app);

      // Edit lock configuration
      const EDIT_LOCK_DURATION = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
      const LOCKED_FIELDS = ['name', 'phone']; // Fields that trigger the lock

      // Check if a field is locked
      function isFieldLocked(fieldName) {
        const lockData = localStorage.getItem(`editLock_${fieldName}`);
        if (!lockData) return false;

        const { timestamp } = JSON.parse(lockData);
        const now = Date.now();
        
        if (now - timestamp < EDIT_LOCK_DURATION) {
          return true;
        } else {
          // Lock expired, remove it
          localStorage.removeItem(`editLock_${fieldName}`);
          return false;
        }
      }

      // Get remaining lock time in readable format
      function getRemainingLockTime(fieldName) {
        const lockData = localStorage.getItem(`editLock_${fieldName}`);
        if (!lockData) return null;

        const { timestamp } = JSON.parse(lockData);
        const now = Date.now();
        const remaining = EDIT_LOCK_DURATION - (now - timestamp);

        if (remaining <= 0) {
          localStorage.removeItem(`editLock_${fieldName}`);
          return null;
        }

        const hours = Math.floor(remaining / (1000 * 60 * 60));
        const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
        
        return `${hours}h ${minutes}m`;
      }

      // Lock a field for 24 hours
      function lockField(fieldName) {
        localStorage.setItem(`editLock_${fieldName}`, JSON.stringify({
          timestamp: Date.now()
        }));
        updateEditButtonState(fieldName);
      }

      // Update edit button state based on lock status
      function updateEditButtonState(fieldName) {
        const button = document.getElementById(`edit-${fieldName}-button`);
        if (!button) return;

        if (isFieldLocked(fieldName)) {
          const remaining = getRemainingLockTime(fieldName);
          button.disabled = true;
          button.textContent = `Locked (${remaining})`;
          button.style.opacity = '0.5';
          button.style.cursor = 'not-allowed';

          // Update timer every minute
          const timer = setInterval(() => {
            const newRemaining = getRemainingLockTime(fieldName);
            if (!newRemaining) {
              clearInterval(timer);
              button.disabled = false;
              button.textContent = `Edit ${fieldName}`;
              button.style.opacity = '1';
              button.style.cursor = 'pointer';
            } else {
              button.textContent = `Locked (${newRemaining})`;
            }
          }, 60000);
        } else {
          button.disabled = false;
          button.textContent = `Edit ${fieldName}`;
          button.style.opacity = '1';
          button.style.cursor = 'pointer';
        }
      }

      // DOM Elements
      const elements = {
        profilePic: document.getElementById('profile-pic'),
        profilePicInput: document.getElementById('profile-pic-input'),
        changePicButton: document.getElementById('change-pic-button'),
        editNameButton: document.getElementById('edit-name-button'),
        editNameContainer: document.getElementById('edit-name-container'),
        newNameInput: document.getElementById('new-name-input'),
        saveNameButton: document.getElementById('save-name-button'),
        cancelNameButton: document.getElementById('cancel-name-button'),
        editPhoneButton: document.getElementById('edit-phone-button'),
        editPhoneContainer: document.getElementById('edit-phone-container'),
        newPhoneInput: document.getElementById('new-phone-input'),
        savePhoneButton: document.getElementById('save-phone-button'),
        cancelPhoneButton: document.getElementById('cancel-phone-button'),
        regionSelect: document.getElementById('region-select'),
        countySelect: document.getElementById('county-select'),
        constituencySelect: document.getElementById('constituency-select'),
        wardSelect: document.getElementById('ward-select'),
        specificDetails: document.getElementById('specific-details'),
        saveLocationButton: document.getElementById('save-location-button'),
        userEmail: document.getElementById('user-email'),
        userName: document.getElementById('user-name'),
        userPhone: document.getElementById('user-phone'),
        userRegion: document.getElementById('user-region'),
        userCounty: document.getElementById('user-county'),
        userWard: document.getElementById('user-ward'),
        userSpecificLocation: document.getElementById('user-specific-location'),
        userConstituency: document.getElementById('user-constituency'), // Add this line
        accountBalance: document.getElementById('account-balance'),
        toggleBalance: document.getElementById('toggle-balance'),
        profileNotification: document.getElementById('profile-notification'),
        editLocationButton: document.getElementById('edit-location-button'),
        locationSelection: document.getElementById('location-selection')
      };

      // Location data
      const counties = {
        "coast": {
          "Mombasa": {
            "Changamwe": ["Port Reitz", "Kipevu", "Airport", "Chaani"],
            "Jomvu": ["Miritini", "Mikindani", "Jomvu Kuu"],
            "Nyali": ["Frere Town", "Kongowea", "Kadzandani", "Mkomani"],
            "Kisauni": ["Mjambere", "Junda", "Bamburi", "Mwakirunge"],
            "Likoni": ["Mtongwe", "Shika Adabu", "Bofu", "Likoni"],
            "Mvita": ["Tudor", "Tononoka", "Majengo", "Ganjoni/Shimanzi"]
          },
          "Kwale": {
            "Matuga": ["Tiwi", "Waa", "Tsimba Golini", "Kubo South"],
            "Msambweni": ["Gombato Bongwe", "Ukunda", "Kinondo", "Ramisi"],
            "Lunga Lunga": ["Pongwe/Kikoneni", "Dzombo", "Mwereni", "Vanga"],
            "Kinango": ["Ndavaya", "Puma", "Kinango", "Mackinnon Road"]
          },
          "Kilifi": {
            "Kilifi North": ["Tezo", "Sokoni", "Kibarani", "Dabaso"],
            "Kilifi South": ["Junju", "Mwarakaya", "Chasimba", "Shimo La Tewa"],
            "Malindi": ["Ganda", "Malindi Town", "Jilore", "Shella"],
            "Magarini": ["Marafa", "Magarini", "Gongoni", "Adu"],
            "Rabai": ["Rabai/Kisurutini", "Ruruma", "Mwawesa", "Kambe/Ribe"],
            "Kaloleni": ["Kaloleni", "Mariakani", "Kayafungo", "Mwanamwinga"]
          },
          "Tana River": {
            "Galole": ["Wayu", "Kinakomba", "Mikinduni", "Chewani"],
            "Garsen": ["Garsen Central", "Garsen South", "Garsen North", "Kipini East"],
            "Bura": ["Chewele", "Hirimani", "Madogo", "Sala"]
          },
          "Lamu": {
            "Lamu East": ["Faza", "Kiunga", "Basuba"],
            "Lamu West": ["Mkomani", "Hindi", "Mkunumbi", "Bahari"]
          },
          "Taita-Taveta": {
            "Voi": ["Kaloleni", "Ngolia", "Mbololo", "Sagala"],
            "Wundanyi": ["Wundanyi/Mbale", "Werugha", "Mwanda/Mgange", "Wumingu/Kishushe"],
            "Mwatate": ["Mwatate", "Chawia", "Bura", "Ronge"],
            "Taveta": ["Chala", "Mboghoni", "Bomani", "Njukini"]
          }
        },
        "north-eastern": {
          "Garissa": {
            "Dadaab": ["Dertu", "Dadaab", "Labasigale", "Damajale"],
            "Fafi": ["Bura", "Dekaharia", "Jarajara", "Nanighi"],
            "Ijara": ["Masalani", "Ijara", "Hulugho", "Sangailu"],
            "Lagdera": ["Modogashe", "Benane", "Goreale", "Maadogashe"],
            "Balambala": ["Balambala", "Saka", "Danyere", "Jarajara"],
            "Garissa Township": ["Waberi", "Galbet", "Iftin", "Township"]
          },
          "Wajir": {
            "Wajir East": ["Barwaqo", "Khorof Harar", "Wagberi", "Township"],
            "Wajir West": ["Arbajahan", "Hadado", "Ganyure", "Ademasajida"],
            "Eldas": ["Eldas", "Della", "Lakoley South", "Lakoley North"],
            "Tarbaj": ["Tarbaj", "Elben", "Sarman", "Wargadud"],
            "Wajir North": ["Bute", "Gurar", "Korondille", "Batalu"],
            "Wajir South": ["Habasswein", "Buna", "Dadajabula", "Diif"]
          },
          "Mandera": {
            "Mandera East": ["Neboi", "Township", "Khalalio", "Libehia"],
            "Mandera West": ["Takaba", "Lagsure", "Dandu", "Gither"],
            "Banissa": ["Banissa", "Malkamari", "Guba", "Derkale"],
            "Mandera North": ["Rhamu", "Ashabito", "Gither", "Marothile"],
            "Lafey": ["Lafey", "Sala", "Warankara", "Fino"],
            "Mandera South": ["Elwak South", "Elwak North", "Wargadud", "Shimbir Fatuma"]
          }
        },
        "eastern": {
          "Embu": {
            "Manyatta": ["Kithimu", "Nginda", "Ruguru/Ngandori", "Mbeti North"],
            "Runyenjes": ["Kyeni North", "Kyeni South", "Kagaari North", "Kagaari South"],
            "Mbeere South": ["Mwea", "Makima", "Mavuria", "Kiambere"],
            "Mbeere North": ["Evurore", "Nthawa", "Muminji", "Siakago"]
          },
          "Kitui": {
            "Kitui Central": ["Township", "Miambani", "Mulango", "Kyangwithya East"],
            "Kitui West": ["Mutonguni", "Matinyani", "Kwa Mutonga/Kithumula", "Yatta/Kwa Vonza"],
            "Mwingi North": ["Kyuso", "Ngomeni", "Tseikuru", "Tharaka"],
            "Mwingi West": ["Kyome/Thaana", "Nguni", "Migwani", "Nuu"],
            "Mwingi Central": ["Central", "Nguni", "Migwani", "Nuu"],
            "Kitui East": ["Nzambani", "Chuluni", "Zombe/Mwitika", "Mutitu/Kaliku"],
            "Kitui South": ["Ikutha", "Mutomo", "Mutha", "Athi"]
          },
          "Machakos": {
            "Machakos Town": ["Mumbuni North", "Mumbuni South", "Mutituni", "Mua"],
            "Mavoko": ["Athi River", "Kinanie", "Mlolongo", "Syokimau"],
            "Kangundo": ["Kangundo North", "Kangundo Central", "Kangundo East", "Kangundo South"],
            "Yatta": ["Ndalani", "Kithimani", "Matuu", "Katangi"],
            "Masinga": ["Ekalakala", "Masinga Central", "Muthesya", "Kivaa"],
            "Kathiani": ["Mitaboni", "Kathiani Central", "Iveti", "Kangundo West"],
            "Mwala": ["Mwala", "Makutano/Mwala", "Masii", "Kibauni"]
          },
          "Makueni": {
            "Makueni": ["Wote", "Muvau/Kikumini", "Kathonzweni", "Mbitini"],
            "Kibwezi West": ["Makindu", "Nguumo", "Kiboko", "Nguu/Masumba"],
            "Kaiti": ["Ukia", "Kee", "Kilungu", "Ilima"],
            "Kibwezi East": ["Mtito Andei", "Masongaleni", "Thange", "Ivingoni/Nzambani"],
            "Kilome": ["Kasikeu", "Mukaa", "Kiima Kiu/Kalanzoni"]
          },
          "Meru": {
            "Imenti North": ["Municipality", "Ntima East", "Ntima West", "Nyaki East"],
            "Imenti South": ["Abogeta East", "Abogeta West", "Igoji East", "Igoji West"],
            "Tigania West": ["Athwana", "Kianjai", "Mikinduri", "Mbeu"],
            "Tigania East": ["Thangatha", "Mikinduri", "Karama", "Muthara"],
            "Igembe South": ["Akachiu", "Athiru Ruujine", "Kangeta", "Igembe Central"],
            "Igembe Central": ["Igembe East", "Igembe North", "Igembe South", "Igembe Central"],
            "Igembe North": ["Amwathi", "Antubetwe Kiongo", "Antuambui", "Ntunene"],
            "Buuri": ["Timau", "Kisima", "Kiirua/Naari", "Ruiri/Rwarera"]
          },
          "Tharaka-Nithi": {
            "Chuka/Igambang'ombe": ["Karingani", "Magumoni", "Igambang'ombe", "Mugwe"],
            "Maara": ["Muthambi", "Mwimbi", "Ganga", "Chogoria"],
            "Tharaka": ["Tharaka North", "Tharaka South", "Gatunga", "Mukothima"]
          }
        },
        "central": {
          "Kiambu": {
            "Kiambu Town": ["Township", "Ndumberi", "Riabai", "Ting'ang'a"],
            "Ruiru": ["Biashara", "Gitothua", "Kahawa Sukari", "Kahawa Wendani"],
            "Thika Town": ["Township", "Kamenu", "Hospital", "Gatuanyaga"],
            "Juja": ["Witeithie", "Murera", "Theta", "Juja"],
            "Gatundu South": ["Kiamwangi", "Kiganjo", "Ndarugu", "Ng'enda"],
            "Gatundu North": ["Gituamba", "Kirimiri", "Kiganjo", "Chania"],
            "Githunguri": ["Githunguri", "Ikinu", "Komothai", "Ngewa"],
            "Kabete": ["Kabete", "Gitaru", "Nyathuna", "Uthiru"],
            "Kikuyu": ["Kikuyu", "Karai", "Sigona", "Zambezi"],
            "Limuru": ["Limuru Central", "Limuru East", "Limuru West", "Ndeiya"],
            "Lari": ["Lari/Kirenga", "Kijabe", "Nyanduma", "Kamburu"]
          },
          "Kirinyaga": {
            "Kirinyaga Central": ["Kerugoya", "Kutus", "Inoi", "Kanyekini"],
            "Mwea": ["Mwea", "Tebere", "Mutithi", "Gathigiriri"],
            "Gichugu": ["Kabare", "Njukiini", "Ngariama", "Baragwi"],
            "Ndia": ["Mukure", "Kariti", "Kiine", "Kanyekini"]
          },
          "Murang'a": {
            "Kiharu": ["Mugoiri", "Wangu", "Mbiri", "Township"],
            "Kandara": ["Gaichanjiru", "Ithiru", "Kagunduini", "Muruka"],
            "Kangema": ["Kanyenya-ini", "Muguru", "Ruchu", "Gatanga"],
            "Mathioya": ["Gitugi", "Kiru", "Kamacharia", "Kariara"],
            "Maragua": ["Kimorori/Wempa", "Makuyu", "Kambiti", "Ichagaki"],
            "Gatanga": ["Kariara", "Kihumbu-ini", "Kakuzi/Mitubiri", "Mugumoini"]
          },
          "Nyeri": {
            "Nyeri Town": ["Rware", "Kamakwa/Mukaro", "Kiganjo/Mathari", "Gatitu/Muruguru"],
            "Tetu": ["Wamagana", "Dedan Kimathi", "Aguthi/Gaaki", "Gakawa"],
            "Mathira": ["Konyu", "Ragati", "Kirimukuyu", "Karatina Town"],
            "Othaya": ["Mahiga", "Chinga", "Iria-ini", "Karima"],
            "Mukurweini": ["Gikondi", "Rugi", "Mukurweini Central", "Kirimukuyu"],
            "Kieni": ["Mweiga", "Naromoru/Kiamathaga", "Gatarakwa", "Thegu River"]
          },
          "Nyandarua": {
            "Ol Kalou": ["Karau", "Kaimbaga", "Rurii", "Mirangine"],
            "Kinangop": ["Engineer", "Gathara", "Njabini/Kiburu", "North Kinangop"],
            "Ndaragwa": ["Central", "Kiriita", "Leshau/Pondo", "Shamata"],
            "Ol Jorok": ["Gathanji", "Gatimu", "Weru", "Charagita"],
            "Kipipiri": ["Kipipiri", "Geta", "Wanjohi", "Githioro"]
          }
        },
        "rift-valley": {
          "Baringo": {
            "Baringo Central": ["Kabarnet", "Sacho", "Tenges", "Ewalel/Chapchap"],
            "Baringo North": ["Barwessa", "Kabartonjo", "Saimo/Kipsaraman", "Saimo/Soi"],
            "Mogotio": ["Mogotio", "Emining", "Kisanana", "Lembus"],
            "Tiaty": ["Kolowa", "Tangulbei/Korossi", "Churo/Amaya", "Ribkwo"],
            "Eldama Ravine": ["Lembus", "Lembus Kwen", "Ravine", "Mumberes/Maji Mazuri"],
            "Baringo South": ["Marigat", "Ilchamus", "Mochongoi", "Mukutani"]
          },
          "Bomet": {
            "Bomet Central": ["Ndaraweta", "Singorwet", "Mutarakwa", "Chesoen"],
            "Bomet East": ["Longisa", "Kembu", "Chemaner", "Merigi"],
            "Chepalungu": ["Sigor", "Chebunyo", "Siongiroi", "Nyangores"],
            "Sotik": ["Kapletundo", "Ndanai/Abosi", "Chemagel", "Rongena/Manaret"],
            "Konoin": ["Kimulot", "Mogogosiek", "Boito", "Embomos"]
          },
          "Elgeyo-Marakwet": {
            "Keiyo North": ["Kamariny", "Kapchemutwa", "Tambach", "Kaptarakwa"],
            "Keiyo South": ["Chepkorio", "Kabiemit", "Soy North", "Soy South"],
            "Marakwet East": ["Kapyego", "Endo", "Embobut/Embolot", "Sambirir"],
            "Marakwet West": ["Lelan", "Sengwer", "Cherangany/Chebororwa", "Moiben/Kuserwo"]
          },
          "Kajiado": {
            "Kajiado Central": ["Purko", "Ildamat", "Dalalekutuk", "Matapato North"],
            "Kajiado North": ["Ongata Rongai", "Ngong", "Olkeri", "Nkaimurunya"],
            "Kajiado South": ["Kimana", "Entonet/Lenkism", "Kuku", "Rombo"],
            "Kajiado East": ["Kitengela", "Oloosirkon/Sholinke", "Kaputiei North", "Kenya Marble Quarry"],
            "Kajiado West": ["Keekonyokie", "Iloodokilani", "Magadi", "Ewuaso Oonkidong'i"]
          },
          "Kericho": {
            "Ainamoi": ["Kapsoit", "Kipchebor", "Kapsaos", "Kipchimchim"],
            "Belgut": ["Cheptororiet/Seretut", "Kabianga", "Waldai", "Chaik"],
            "Kipkelion East": ["Londiani", "Kedowa/Kimugul", "Chepseon", "Tendeno/Sorget"],
            "Kipkelion West": ["Kunyak", "Kamasian", "Chilchila", "Kipkelion"],
            "Bureti": ["Cheboin", "Chemosot", "Kapkatet", "Litein"],
            "Soin/Sigowet": ["Sigowet", "Soin", "Kaplelartet", "Kaplelartet"]
          },
          "Laikipia": {
            "Laikipia East": ["Nanyuki", "Tigithi", "Thingithu", "Ngobit"],
            "Laikipia North": ["Mukogodo East", "Mukogodo West", "Sosian", "Segera"],
            "Laikipia West": ["Rumuruti", "Ol Moran", "Githiga", "Salama"]
          },
          "Nakuru": {
            "Nakuru Town East": ["Biashara", "Kivumbini", "Flamingo", "Menengai"],
            "Nakuru Town West": ["Kaptembwa", "London", "Rhoda", "Barut"],
            "Naivasha": ["Biashara", "Hells Gate", "Lake View", "Mai Mahiu"],
            "Molo": ["Molo", "Elburgon", "Turi", "Sachangwan"],
            "Njoro": ["Njoro", "Mau Narok", "Kihingo", "Lare"],
            "Rongai": ["Rongai", "Soin", "Visoi", "Menengai West"],
            "Kuresoi South": ["Amalo", "Kiptagich", "Tinet", "Keringet"],
            "Kuresoi North": ["Kamara", "Nyota", "Sirikwa", "Kiptororo"],
            "Subukia": ["Subukia", "Waseges", "Kabazi", "Kiamaina"],
            "Gilgil": ["Gilgil", "Elementaita", "Murindat", "Eburru"],
            "Bahati": ["Bahati", "Dundori", "Kabatini", "Lanet/Umoja"]
          },
          "Narok": {
            "Narok North": ["Olokurto", "Olorropil", "Olposimoru", "Melili"],
            "Narok South": ["Loita", "Mara", "Sogoo", "Ololulung'a"],
            "Narok East": ["Ilmotiok", "Mosiro", "Suswa", "Keekonyokie"],
            "Narok West": ["Melelo", "Ilkerin", "Maji Moto/Naroosura", "Siana"],
            "Emurua Dikirr": ["Ololmasani", "Ilkerin", "Maji Moto/Naroosura", "Siana"]
          },
          "Nandi": {
            "Aldai": ["Kaptumo/Kaboi", "Koyo/Ndurio", "Kabwareng", "Kemeloi/Maraba"],
            "Emgwen": ["Kapsabet", "Kilibwoni", "Chepkumia", "Kapkangani"],
            "Mosop": ["Kipkaren", "Ndalat", "Kabisaga", "Chepterwai"],
            "Chesumei": ["Chemundu/Kapng'etuny", "Kosirai", "Kiptuya", "Kaptel/Kamoiywo"],
            "Nandi Hills": ["Nandi Hills", "Chepkunyuk", "Ol'lessos", "Kapchorwa"],
            "Tinderet": ["Songhor/Soba", "Tindiret", "Chemelil/Chemase", "Kipchamo"]
          },
          "Samburu": {
            "Samburu East": ["Waso", "Wamba North", "Wamba West", "Wamba East"],
            "Samburu North": ["Nachola", "Ndoto", "Nyiro", "Elbarta"],
            "Samburu West": ["Suguta Marmar", "Maralal", "Loosuk", "Poro"]
          },
          "Trans-Nzoia": {
            "Kiminini": ["Kiminini", "Waitaluk", "Sirende", "Nabiswa"],
            "Kwanza": ["Kwanza", "Keiyo", "Kapomboi", "Bidii"],
            "Saboti": ["Saboti", "Matisi", "Tuwani", "Machewa"],
            "Endebess": ["Endebess", "Chepchoina", "Matumbei", "Kwanza"],
            "Cherangany": ["Cherangany", "Sitatunga", "Makutano", "Motosiet"]
          },
          "Turkana": {
            "Turkana Central": ["Kerio Delta", "Kang'atotha", "Kalokol", "Kanamkemer"],
            "Turkana East": ["Lokori/Kochodin", "Katilia", "Kapedo/Napeitom", "Lokichar"],
            "Turkana South": ["Katilu", "Lobokat", "Kaputir", "Lokichar"],
            "Turkana North": ["Kaeris", "Kaaleng/Kaikor", "Lake Zone", "Lapur"],
            "Turkana West": ["Kakuma", "Lopur", "Letea", "Songot"],
            "Loima": ["Loima", "Turkwel", "Lobei/Kotaruk", "Lorugum"]
          },
          "Uasin Gishu": {
            "Ainabkoi": ["Kapsoya", "Kaptagat", "Ainabkoi/Olare", "Kipkabus"],
            "Kapseret": ["Langas", "Simat/Kapseret", "Kipkenyo", "Ngeria"],
            "Kesses": ["Racecourse", "Cheptiret/Kipchamo", "Tarakwa", "Tulwet/Chuiyat"],
            "Moiben": ["Karuna/Meibeki", "Sergoit", "Tembelio", "Kimumu"],
            "Soy": ["Soy", "Kipsomba", "Ziwa", "Segero/Barsombe"],
            "Turbo": ["Kamagut", "Kapsaos", "Kipkaren", "Ngenyilel"]
          },
          "West Pokot": {
            "Kapenguria": ["Kapenguria", "Siyoi", "Mnagei", "Riwo"],
            "Sigor": ["Sigor", "Lomut", "Weiwei", "Masol"],
            "Kacheliba": ["Kacheliba", "Suam", "Kodich", "Kasei"],
            "Pokot South": ["Chepareria", "Batei", "Lelan", "Tapach"]
          }
        },
        "western": {
          "Bungoma": {
            "Kanduyi": ["Bukembe West", "Bukembe East", "Khalaba", "Township"],
            "Kabuchai": ["Kabuchai/Chwele", "West Nalondo", "Bwake/Luuya", "Mukuyuni"],
            "Kimilili": ["Kimilili", "Maeni", "Kibingei", "Kibingei"],
            "Tongaren": ["Tongaren", "Milima", "Naitiri/Kabuyefwe", "Ndalu/Tabani"],
            "Webuye East": ["Mihuu", "Ndivisi", "Maraka", "Misikhu"],
            "Webuye West": ["Sitikho", "Matulo", "Bokoli", "Misikhu"],
            "Mt. Elgon": ["Cheptais", "Kaptama", "Kapsokwony", "Chepyuk"],
            "Sirisia": ["Lwandanyi", "Namwela", "Malakisi/South Kulisiru", "Cheptais"]
          },
          "Busia": {
            "Matayos": ["Matayos South", "Matayos North", "Burumba", "Bukhayo West"],
            "Nambale": ["Nambale Township", "Bukhayo North/Walatsi", "Bukhayo East", "Bukhayo Central"],
            "Teso North": ["Ang'urai South", "Ang'urai North", "Ang'urai East", "Malaba Central"],
            "Teso South": ["Amukura Central", "Amukura East", "Amukura West", "Chakol South"],
            "Butula": ["Marachi Central", "Marachi East", "Marachi West", "Marachi North"],
            "Funyula": ["Namboboto/Nambuku", "Ageng'a Nanguba", "Bwiri", "Funyula"],
            "Budalangi": ["Bunyala Central", "Bunyala North", "Bunyala South", "Bunyala West"]
          },
          "Kakamega": {
            "Lurambi": ["Butsotso Central", "Butsotso East", "Butsotso South", "Shirere"],
            "Malava": ["West Kabras", "East Kabras", "South Kabras", "Central Kabras"],
            "Mumias East": ["Malaha/Isongo/Makunga", "East Wanga", "Central Wanga", "West Wanga"],
            "Mumias West": ["Mumias Central", "Mumias North", "Mumias South", "Mumias East"],
            "Matungu": ["Kholera", "Koyonzo", "Namamali", "Mayoni"],
            "Navakholo": ["Ingotse/Matiha", "Shinoyi/Shikomari/Esumeyia", "Bunyala West", "Bunyala East"],
            "Shinyalu": ["Murhanda", "Isukha Central", "Isukha East", "Isukha South"],
            "Ikolomani": ["Idakho South", "Idakho East", "Idakho North", "Idakho Central"],
            "Lugari": ["Lugari", "Chekalini", "Chevaywa", "Mautuma"],
            "Likuyani": ["Likuyani", "Kongoni", "Nzoia", "Sango"],
            "Butere": ["Marama Central", "Marama North", "Marama West", "Marama South"],
            "Khwisero": ["Kisa North", "Kisa East", "Kisa West", "Kisa Central"]
          },
          "Vihiga": {
            "Vihiga": ["Lugaga/Wamuluma", "South Maragoli", "Central Maragoli", "Mungoma"],
            "Sabatia": ["Chavakali", "Busali", "Wodanga", "Lyaduywa/Izava"],
            "Hamisi": ["Shamakhokho", "Banja", "Muhudu", "Tambua"],
            "Emuhaya": ["North East Bunyore", "Central Bunyore", "West Bunyore", "South Bunyore"],
            "Luanda": ["Luanda Township", "Mwibona", "Wemilabi", "Luanda South"]
          }
        },
        "nyanza": {
          "Homa Bay": {
            "Homa Bay Town": ["Homa Bay Central", "Homa Bay East", "Homa Bay West", "Homa Bay North"],
            "Kabondo Kasipul": ["Kabondo East", "Kabondo West", "Kabondo North", "Kabondo South"],
            "Kasipul": ["Kasipul East", "Kasipul West", "Kasipul North", "Kasipul South"],
            "Karachuonyo": ["Karachuonyo East", "Karachuonyo West", "Karachuonyo North", "Karachuonyo South"],
            "Ndhiwa": ["Ndhiwa East", "Ndhiwa West", "Ndhiwa North", "Ndhiwa South"],
            "Rangwe": ["Rangwe East", "Rangwe West", "Rangwe North", "Rangwe South"],
            "Suba North": ["Suba East", "Suba West", "Suba North", "Suba South"],
            "Suba South": ["Suba East", "Suba West", "Suba North", "Suba South"]
          },
          "Kisii": {
            "Kitutu Chache North": ["Kitutu Central", "Kitutu East", "Kitutu West", "Kitutu North"],
            "Kitutu Chache South": ["Kitutu Central", "Kitutu East", "Kitutu West", "Kitutu North"],
            "Nyaribari Chache": ["Nyaribari Central", "Nyaribari East", "Nyaribari West", "Nyaribari North"],
            "Nyaribari Masaba": ["Nyaribari Central", "Nyaribari East", "Nyaribari West", "Nyaribari North"],
            "Bobasi": ["Bobasi Central", "Bobasi East", "Bobasi West", "Bobasi North"],
            "Bomachoge Borabu": ["Bomachoge Central", "Bomachoge East", "Bomachoge West", "Bomachoge North"],
            "Bomachoge Chache": ["Bomachoge Central", "Bomachoge East", "Bomachoge West", "Bomachoge North"],
            "South Mugirango": ["South Mugirango Central", "South Mugirango East", "South Mugirango West", "South Mugirango North"]
          },
          "Kisumu": {
            "Kisumu Central": ["Kisumu Central", "Kisumu East", "Kisumu West", "Kisumu North"],
            "Kisumu East": ["Kisumu Central", "Kisumu East", "Kisumu West", "Kisumu North"],
            "Kisumu West": ["Kisumu Central", "Kisumu East", "Kisumu West", "Kisumu North"],
            "Nyando": ["Nyando Central", "Nyando East", "Nyando West", "Nyando North"],
            "Muhoroni": ["Muhoroni Central", "Muhoroni East", "Muhoroni West", "Muhoroni North"],
            "Nyakach": ["Nyakach Central", "Nyakach East", "Nyakach West", "Nyakach North"],
            "Seme": ["Seme Central", "Seme East", "Seme West", "Seme North"]
          },
          "Migori": {
            "Awendo": ["Awendo Central", "Awendo East", "Awendo West", "Awendo North"],
            "Kuria East": ["Kuria Central", "Kuria East", "Kuria West", "Kuria North"],
            "Kuria West": ["Kuria Central", "Kuria East", "Kuria West", "Kuria North"],
            "Nyatike": ["Nyatike Central", "Nyatike East", "Nyatike West", "Nyatike North"],
            "Rongo": ["Rongo Central", "Rongo East", "Rongo West", "Rongo North"],
            "Suna East": ["Suna Central", "Suna East", "Suna West", "Suna North"],
            "Suna West": ["Suna Central", "Suna East", "Suna West", "Suna North"],
            "Uriri": ["Uriri Central", "Uriri East", "Uriri West", "Uriri North"]
          },
          "Nyamira": {
            "Borabu": ["Borabu Central", "Borabu East", "Borabu West", "Borabu North"],
            "Kitutu Masaba": ["Kitutu Central", "Kitutu East", "Kitutu West", "Kitutu North"],
            "North Mugirango": ["North Mugirango Central", "North Mugirango East", "North Mugirango West", "North Mugirango North"],
            "West Mugirango": ["West Mugirango Central", "West Mugirango East", "West Mugirango West", "West Mugirango North"]
          },
          "Siaya": {
            "Alego Usonga": ["Alego Central", "Alego East", "Alego West", "Alego North"],
            "Bondo": ["Bondo Central", "Bondo East", "Bondo West", "Bondo North"],
            "Gem": ["Gem Central", "Gem East", "Gem West", "Gem North"],
            "Rarieda": ["Rarieda Central", "Rarieda East", "Rarieda West", "Rarieda North"],
            "Ugenya": ["Ugenya Central", "Ugenya East", "Ugenya West", "Ugenya North"],
            "Ugunja": ["Ugunja Central", "Ugunja East", "Ugunja West", "Ugunja North"]
          }
        },
        "nairobi": {
          "Nairobi": {
            "Westlands": ["Kangemi", "Mountain View", "Kitisuru", "Parklands/Highridge"],
            "Kibra": ["Laini Saba", "Lindi", "Makina", "Woodley/Kenyatta Golf Course"],
            "Lang'ata": ["Karen", "Nairobi West", "Mugumo-ini", "South C"],
            "Dagoretti North": ["Kilimani", "Kawangware", "Gatina", "Kileleshwa"],
            "Dagoretti South": ["Mutu-ini", "Ngando", "Riruta", "Uthiru/Ruthimitu"],
            "Embakasi Central": ["Kayole North", "Kayole South", "Komarock", "Matopeni/Spring Valley"],
            "Embakasi East": ["Upper Savannah", "Lower Savannah", "Embakasi", "Utawala"],
            "Embakasi North": ["Kariobangi North", "Dandora Area I", "Dandora Area II", "Dandora Area III"],
            "Embakasi South": ["Imara Daima", "Kwa Njenga", "Kwa Rueben", "Pipeline"],
            "Embakasi West": ["Umoja I", "Umoja II", "Mowlem", "Kariobangi South"],
            "Kamukunji": ["Pumwani", "Eastleigh North", "Eastleigh South", "Airbase"],
            "Kasarani": ["Clay City", "Mwiki", "Kasarani", "Njiru"],
            "Makadara": ["Viwandani", "Harambee", "Makongeni", "Maringo/Hamza"],
            "Mathare": ["Hospital", "Mabatini", "Huruma", "Ngei"],
            "Roysambu": ["Zimmerman", "Githurai", "Kahawa", "Kahawa West"],
            "Ruaraka": ["Baba Dogo", "Utalii", "Mathare North", "Lucky Summer"],
            "Starehe": ["Nairobi Central", "Ngara", "Pangani", "Ziwani/Kariokor"]
          }
        }
      };

      // Profile Picture Handling
      elements.changePicButton.addEventListener('click', () => {
        elements.profilePicInput.click();
      });

      elements.profilePicInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
          try {
            const user = auth.currentUser;
            if (!user) {
              showNotification("User not authenticated", "error");
              return;
            }
            const storageReference = storageRef(storage, `profile-pics/${user.uid}`);
            await uploadBytes(storageReference, file);
            const downloadURL = await getDownloadURL(storageReference);

            await updateDoc(doc(db, "Users", user.uid), {
              profilePicUrl: downloadURL
            });

            elements.profilePic.src = downloadURL;
            showNotification("Profile picture updated successfully!");
          } catch (error) {
            console.error("Error updating profile picture:", error);
            showNotification("Failed to update profile picture", "error");
          }
        }
      });

      // Name Edit Handling
      elements.editNameButton.addEventListener('click', () => {
        if (isFieldLocked('name')) {
          const remaining = getRemainingLockTime('name');
          showNotification(`Name edit is locked. Try again in ${remaining}`, 'warning');
          return;
        }
        elements.editNameContainer.style.display = 'block';
        elements.newNameInput.value = elements.userName.textContent;
      });

      elements.saveNameButton.addEventListener('click', async () => {
        const newName = elements.newNameInput.value.trim();
        if (newName) {
          try {
            await updateDoc(doc(db, "Users", auth.currentUser.uid), { name: newName });
            elements.userName.textContent = newName;
            lockField('name'); // Lock the field after successful save
            elements.editNameContainer.style.display = 'none';
            showNotification("Name updated successfully!");
          } catch (error) {
            showNotification("Failed to update name", "error");
          }
        }
      });

      elements.cancelNameButton.addEventListener('click', () => {
        elements.editNameContainer.style.display = 'none';
      });

      // Phone Edit Handling
      elements.editPhoneButton.addEventListener('click', () => {
        if (isFieldLocked('phone')) {
          const remaining = getRemainingLockTime('phone');
          showNotification(`Phone edit is locked. Try again in ${remaining}`, 'warning');
          return;
        }
        elements.editPhoneContainer.style.display = 'block';
        elements.newPhoneInput.value = elements.userPhone.textContent;
      });

      elements.savePhoneButton.addEventListener('click', async () => {
        const newPhone = elements.newPhoneInput.value.trim();
        if (newPhone) {
          try {
            await updateDoc(doc(db, "Users", auth.currentUser.uid), { phone: newPhone });
            elements.userPhone.textContent = newPhone;
            lockField('phone'); // Lock the field after successful save
            elements.editPhoneContainer.style.display = 'none';
            showNotification("Phone updated successfully!");
          } catch (error) {
            showNotification("Failed to update phone", "error");
          }
        }
      });

      elements.cancelPhoneButton.addEventListener('click', () => {
        elements.editPhoneContainer.style.display = 'none';
      });

      // Location Edit Handling
      elements.regionSelect.addEventListener('change', () => {
        populateCounties();
      });

      elements.countySelect.addEventListener('change', () => {
        populateConstituencies();
      });

      elements.constituencySelect.addEventListener('change', () => {
        populateWards();
      });

      elements.saveLocationButton.addEventListener('click', async () => {
        const locationData = {
          region: elements.regionSelect.value,
          county: elements.countySelect.value,
          constituency: elements.constituencySelect.value,
          ward: elements.wardSelect.value,
          specificLocation: elements.specificDetails.value
        };

        try {
          await updateDoc(doc(db, "Users", auth.currentUser.uid), locationData);
          updateLocationDisplay(locationData);
          elements.locationSelection.style.display = 'none';
          showNotification("Location updated successfully!");
        } catch (error) {
          showNotification("Failed to update location", "error");
        }
      });

      elements.editLocationButton.addEventListener('click', () => {
        elements.locationSelection.style.display = 'block';
      });

      // Helper Functions
      function populateCounties() {
        elements.countySelect.innerHTML = '<option value="" disabled selected>Select County</option>';
        elements.constituencySelect.innerHTML = '<option value="" disabled selected>Select Constituency</option>';
        elements.wardSelect.innerHTML = '<option value="" disabled selected>Select Ward</option>';

        const region = elements.regionSelect.value;
        if (region && counties[region]) {
          Object.keys(counties[region]).forEach(county => {
            const option = document.createElement('option');
            option.value = county;
            option.textContent = county;
            elements.countySelect.appendChild(option);
          });
          elements.countySelect.disabled = false;
        }
      }

      function populateConstituencies() {
        elements.constituencySelect.innerHTML = '<option value="" disabled selected>Select Constituency</option>';
        elements.wardSelect.innerHTML = '<option value="" disabled selected>Select Ward</option>';

        const region = elements.regionSelect.value;
        const county = elements.countySelect.value;

        if (region && county && counties[region][county]) {
          Object.keys(counties[region][county]).forEach(constituency => {
            const option = document.createElement('option');
            option.value = constituency;
            option.textContent = constituency;
            elements.constituencySelect.appendChild(option);
          });
          elements.constituencySelect.disabled = false;
        }
      }

      function populateWards() {
        elements.wardSelect.innerHTML = '<option value="" disabled selected>Select Ward</option>';

        const region = elements.regionSelect.value;
        const county = elements.countySelect.value;
        const constituency = elements.constituencySelect.value;

        if (region && county && constituency && counties[region][county][constituency]) {
          counties[region][county][constituency].forEach(ward => {
            const option = document.createElement('option');
            option.value = ward;
            option.textContent = ward;
            elements.wardSelect.appendChild(option);
          });
          elements.wardSelect.disabled = false;
        }
      }

      function updateLocationDisplay(locationData) {
        elements.userRegion.textContent = locationData.region || "Not Set";
        elements.userCounty.textContent = locationData.county || "Not Set";
        elements.userConstituency.textContent = locationData.constituency || "Not Set";
        elements.userWard.textContent = locationData.ward || "Not Set";
        elements.userSpecificLocation.textContent = locationData.specificLocation || "Not Set";
      }

      // Initialize user data
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          const userDoc = await getDoc(doc(db, "Users", user.uid));
          if (!userDoc.exists()) {
            await setDoc(doc(db, "Users", user.uid), {
              email: user.email,
              name: user.displayName || "",
              phone: "",
              profilePicUrl: "images/profile-placeholder.png"
            });
          }
          const userData = userDoc.data();
          elements.profilePic.src = userData.profilePicUrl || "images/profile-placeholder.png";
          elements.userEmail.textContent = userData.email || user.email;
          elements.userName.textContent = userData.name || "Not Set";
          elements.userPhone.textContent = userData.phone || "Not Set";
          updateLocationDisplay(userData);
          if (!userData.name || !userData.phone) {
            elements.profileNotification.style.display = 'flex';
          }
        }
      });
    </script>
  </body>
</html>

