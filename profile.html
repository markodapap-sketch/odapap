<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="favicon_io/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="favicon_io/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="favicon_io/favicon-16x16.png"><link rel="manifest" href="favicon_io/site.webmanifest">
  <link rel="apple-touch-icon" sizes="180x180" href="favicon_io/apple-touch-icon.png">
  <title>Profile - Oda Pap</title>
  <link rel="stylesheet" href="css/header.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      padding-bottom: 20px;
    }

    /* Profile Hero - Compact */
    .profile-hero {
      background: linear-gradient(135deg, #ff5722, #e64a19);
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .profile-pic {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 3px solid white;
      object-fit: cover;
      cursor: pointer;
      flex-shrink: 0;
    }
    .profile-info {
      flex: 1;
      color: white;
      min-width: 0;
    }
    .profile-name {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .profile-email {
      font-size: 0.75rem;
      opacity: 0.9;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .profile-location {
      font-size: 0.7rem;
      opacity: 0.85;
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .profile-location i { font-size: 0.65rem; }
    .view-public-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 16px;
      font-size: 0.7rem;
      cursor: pointer;
      white-space: nowrap;
    }

    /* Stats Row */
    .stats-row {
      background: white;
      display: flex;
      border-bottom: 1px solid #eee;
    }
    .stat-item {
      flex: 1;
      text-align: center;
      padding: 12px 8px;
      border-right: 1px solid #eee;
    }
    .stat-item:last-child { border-right: none; }
    .stat-value {
      font-size: 1.1rem;
      font-weight: 700;
      color: #ff5722;
    }
    .stat-label {
      font-size: 0.65rem;
      color: #888;
      text-transform: uppercase;
    }

    /* Balance Card - Compact */
    .balance-card {
      background: linear-gradient(135deg, #1a237e, #3949ab);
      margin: 12px;
      border-radius: 10px;
      padding: 14px;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .balance-info h4 {
      font-size: 0.7rem;
      opacity: 0.8;
      margin-bottom: 2px;
    }
    .balance-amount {
      font-size: 1.4rem;
      font-weight: 700;
    }
    .balance-amount.hidden { filter: blur(6px); }
    .balance-toggle {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
    }

    /* Quick Actions Grid */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      padding: 0 12px 12px;
    }
    .quick-action {
      background: white;
      border-radius: 10px;
      padding: 12px 6px;
      text-align: center;
      text-decoration: none;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .quick-action i {
      width: 36px;
      height: 36px;
      background: #fff3e0;
      color: #ff5722;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 6px;
      font-size: 0.9rem;
    }
    .quick-action span {
      font-size: 0.65rem;
      color: #666;
    }

    /* Section Card */
    .section-card {
      background: white;
      margin: 0 12px 12px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .section-header {
      padding: 12px;
      background: #fafafa;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .section-header h3 {
      font-size: 0.8rem;
      font-weight: 600;
      color: #333;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .section-header h3 i { color: #ff5722; font-size: 0.85rem; }
    .edit-btn {
      background: #fff3e0;
      color: #ff5722;
      border: none;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.7rem;
      cursor: pointer;
    }
    .edit-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Info Row */
    .info-row {
      padding: 10px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #f5f5f5;
      font-size: 0.85rem;
    }
    .info-row:last-child { border-bottom: none; }
    .info-label { color: #888; font-size: 0.75rem; }
    .info-value { color: #333; font-weight: 500; }

    /* Edit Container */
    .edit-container {
      display: none;
      padding: 10px 12px;
      background: #fffde7;
      border-top: 1px solid #fff59d;
    }
    .edit-container.active { display: block; }
    .edit-container input {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.85rem;
      margin-bottom: 8px;
    }
    .edit-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }
    .edit-actions button {
      padding: 6px 14px;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
      border: none;
    }
    .btn-save { background: #ff5722; color: white; }
    .btn-cancel { background: #eee; color: #666; }

    /* Location Form */
    .location-form {
      display: none;
      padding: 12px;
      background: #fafafa;
    }
    .location-form.active { display: block; }
    .location-form label {
      display: block;
      font-size: 0.7rem;
      color: #666;
      margin-bottom: 3px;
      margin-top: 8px;
    }
    .location-form label:first-child { margin-top: 0; }
    .location-form select, .location-form textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.8rem;
      background: white;
    }
    .btn-detect-location {
      width: 100%;
      padding: 10px;
      background: linear-gradient(135deg, #1a73e8, #4285f4);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.82rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 12px;
      transition: opacity 0.2s;
    }
    .btn-detect-location:hover { opacity: 0.9; }
    .btn-detect-location:disabled { opacity: 0.5; cursor: wait; }
    .detect-status {
      font-size: 0.75rem;
      padding: 8px 12px;
      border-radius: 6px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .detect-status.loading { background: #e3f2fd; color: #1565c0; }
    .detect-status.success { background: #e8f5e9; color: #2e7d32; }
    .detect-status.error   { background: #fce4ec; color: #c62828; }
    .btn-map-toggle {
      background: none;
      border: 1px dashed #aaa;
      border-radius: 6px;
      padding: 8px 14px;
      color: #555;
      font-size: 0.78rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background .2s;
    }
    .btn-map-toggle:hover { background: #f0f0f0; }
    .map-container {
      margin-top: 8px;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #ddd;
    }
    .leaflet-map {
      width: 100%;
      height: 220px;
    }
    .map-hint {
      text-align: center;
      font-size: 0.7rem;
      color: #888;
      padding: 6px;
      background: #fafafa;
    }

    /* Seller Orders - Compact */
    .orders-tabs {
      display: flex;
      overflow-x: auto;
      border-bottom: 1px solid #eee;
      -webkit-overflow-scrolling: touch;
    }
    .order-tab {
      flex: 0 0 auto;
      padding: 10px 14px;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      color: #888;
      font-size: 0.7rem;
      cursor: pointer;
      white-space: nowrap;
    }
    .order-tab.active {
      color: #ff5722;
      border-bottom-color: #ff5722;
    }
    .order-tab-count {
      font-weight: 700;
      display: block;
      font-size: 0.9rem;
    }
    .orders-list {
      max-height: 280px;
      overflow-y: auto;
    }
    .order-card {
      padding: 10px 12px;
      border-bottom: 1px solid #f5f5f5;
    }
    .order-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .order-id { font-size: 0.7rem; color: #888; }
    .order-status {
      font-size: 0.65rem;
      padding: 2px 6px;
      border-radius: 3px;
      font-weight: 500;
    }
    .order-status.pending { background: #fff3cd; color: #856404; }
    .order-status.processing { background: #cce5ff; color: #004085; }
    .order-status.shipped { background: #d4edda; color: #155724; }
    .order-status.delivered { background: #c3e6cb; color: #155724; }
    .order-status.cancelled { background: #f8d7da; color: #721c24; }
    .order-card-body {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .order-items-preview {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .order-item-row {
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 6px;
      background: #f9f9f9;
      border-radius: 8px;
    }
    .order-item-img {
      width: 44px;
      height: 44px;
      border-radius: 6px;
      object-fit: cover;
      flex-shrink: 0;
    }
    .order-item-details { flex: 1; min-width: 0; }
    .order-item-name {
      font-size: 0.8rem;
      font-weight: 500;
      color: #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .order-item-variant {
      font-size: 0.7rem;
      color: #ff5722;
      background: #fff3e0;
      padding: 2px 6px;
      border-radius: 4px;
      display: inline-block;
      margin-top: 2px;
    }
    .order-item-qty { 
      font-size: 0.7rem; 
      color: #666;
      margin-top: 2px;
    }
    .order-item-price {
      font-size: 0.8rem;
      font-weight: 600;
      color: #333;
      text-align: right;
    }
    .order-summary-row {
      display: flex;
      justify-content: space-between;
      padding-top: 8px;
      border-top: 1px dashed #eee;
      margin-top: 4px;
    }
    .order-buyer-info {
      font-size: 0.7rem;
      color: #666;
    }
    .order-total {
      font-size: 0.9rem;
      font-weight: 700;
      color: #ff5722;
    }
    .order-actions {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }
    .order-action-btn {
      flex: 1;
      padding: 6px;
      border: none;
      border-radius: 4px;
      font-size: 0.7rem;
      cursor: pointer;
    }
    .btn-accept { background: #4caf50; color: white; }
    .btn-ship { background: #2196f3; color: white; }
    .btn-complete { background: #ff5722; color: white; }
    .btn-cancel-order { background: #f5f5f5; color: #666; }
    .orders-empty {
      text-align: center;
      padding: 30px;
      color: #999;
      font-size: 0.85rem;
    }
    .orders-empty i { font-size: 2rem; color: #ddd; margin-bottom: 8px; display: block; }

    /* Menu Links */
    .menu-links {
      background: white;
      margin: 0 12px 12px;
      border-radius: 10px;
      overflow: hidden;
    }
    .menu-link {
      display: flex;
      align-items: center;
      padding: 12px;
      text-decoration: none;
      color: #333;
      border-bottom: 1px solid #f5f5f5;
    }
    .menu-link:last-child { border-bottom: none; }
    .menu-link i {
      width: 32px;
      height: 32px;
      background: #f5f5f5;
      color: #666;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
      font-size: 0.8rem;
    }
    .menu-link span { flex: 1; font-size: 0.85rem; }
    .menu-link .arrow { color: #ccc; font-size: 0.75rem; }
    .menu-link.danger i { background: #ffebee; color: #e53935; }
    .menu-link.danger span { color: #e53935; }

    /* Profile Prompt */
    .profile-prompt {
      background: linear-gradient(135deg, #ff5722, #ff8a65);
      margin: 12px;
      border-radius: 10px;
      padding: 14px;
      color: white;
      display: none;
    }
    .profile-prompt h4 {
      font-size: 0.9rem;
      margin-bottom: 4px;
    }
    .profile-prompt p {
      font-size: 0.75rem;
      opacity: 0.9;
      margin-bottom: 10px;
    }
    .profile-prompt button {
      background: white;
      color: #ff5722;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
    }

    /* Bottom Nav - removed, using top nav */
    
    /* Hidden */
    .hidden-input { display: none; }

    /* Order Modal Styles */
    .order-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    .order-modal-content {
      background: white;
      border-radius: 12px;
      width: 100%;
      max-width: 450px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .order-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid #eee;
      position: sticky;
      top: 0;
      background: white;
      border-radius: 12px 12px 0 0;
    }
    .order-modal-header h3 {
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #ff5722;
    }
    .order-modal-close {
      background: #f5f5f5;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
    }
    .order-modal-body { padding: 16px; }
    .order-detail-section {
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid #f0f0f0;
    }
    .order-detail-section h4 {
      font-size: 0.8rem;
      color: #666;
      margin-bottom: 8px;
      text-transform: uppercase;
    }
    .order-detail-section p {
      font-size: 0.85rem;
      color: #333;
      margin: 4px 0;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .order-detail-section p i { color: #999; font-size: 0.8rem; }
    .order-detail-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      background: #fafafa;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .order-detail-item img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 6px;
    }
    .order-detail-item-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .order-detail-item-info strong { font-size: 0.85rem; color: #333; }
    .order-detail-item-info small { font-size: 0.7rem; color: #999; }
    .order-detail-item-info span { font-size: 0.75rem; color: #666; }
    .order-detail-item-price {
      font-weight: 600;
      color: #ff5722;
      font-size: 0.9rem;
    }
    .order-detail-totals {
      background: #f9f9f9;
      padding: 12px;
      border-radius: 8px;
    }
    .order-detail-totals > div {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      margin-bottom: 4px;
    }
    .order-detail-totals .total-row {
      font-weight: 700;
      font-size: 1rem;
      border-top: 1px solid #ddd;
      padding-top: 8px;
      margin-top: 8px;
      color: #ff5722;
    }

    /* Download App Banner */
    .download-app-banner {
      margin: 12px;
      background: linear-gradient(135deg, #1a73e8, #4285f4);
      border-radius: 12px;
      padding: 14px 16px;
      color: white;
    }
    .download-app-inner {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .download-app-icon img {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      border: 2px solid rgba(255,255,255,0.3);
    }
    .download-app-text {
      flex: 1;
      min-width: 0;
    }
    .download-app-text strong {
      display: block;
      font-size: 0.9rem;
    }
    .download-app-text span {
      font-size: 0.7rem;
      opacity: 0.9;
    }
    .download-app-btn {
      background: white;
      color: #1a73e8;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 700;
      cursor: pointer;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .download-app-btn:active { transform: scale(0.96); }
  </style>
</head>
<body>
  <header class="oda-header">
    <div class="header-top-bar">
      <div class="header-logo" onclick="location.href='index.html'">
        <img src="images/logo.png" alt="Oda Pap" class="header-logo-img">
        <span class="header-logo-text">Oda Pap</span>
      </div>
      <div class="header-search">
        <form id="searchForm" action="search-results.html" method="GET">
          <input type="text" name="q" id="searchInput" placeholder="Search products..." autocomplete="off">
          <button type="submit"><i class="fas fa-search"></i></button>
        </form>
      </div>
      <div class="header-menu-toggle" onclick="toggleOdaMenu()">
        <i class="fas fa-th-large"></i>
        <span>Menu</span>
      </div>
    </div>
    <div class="header-divider"></div>
    <nav class="header-nav">
      <button class="header-nav-btn" onclick="location.href='index.html'"><i class="fas fa-home"></i></button>
      <button class="header-nav-btn" onclick="location.href='notification.html'"><i class="fas fa-bell"></i><span class="header-nav-counter" id="notification-count"></span></button>
      <button class="header-nav-btn" onclick="location.href='cart.html'"><i class="fas fa-shopping-cart"></i><span class="header-nav-counter" id="cart-count"></span></button>
      <button class="header-nav-btn" onclick="location.href='wishlist.html'"><i class="fas fa-heart"></i><span class="header-nav-counter" id="wishlist-count"></span></button>
      <button class="header-nav-btn active" onclick="location.href='profile.html'"><i class="fas fa-user-circle"></i></button>
    </nav>
  </header>

  <!-- Mega Menu -->
  <div class="oda-menu-overlay" id="odaMenuOverlay" onclick="closeOdaMenu()"></div>
  <div class="oda-mega-menu" id="odaMegaMenu">
    <div class="mega-menu-header">
      <h3><i class="fas fa-th-large"></i> Quick Menu</h3>
      <button class="mega-menu-close" onclick="closeOdaMenu()"><i class="fas fa-times"></i></button>
    </div>
    <div class="mega-menu-section">
      <h4>Categories</h4>
      <div class="mega-menu-grid">
        <a href="category.html?category=electronics"><i class="fas fa-tv"></i> Electronics</a>
        <a href="category.html?category=fashion"><i class="fas fa-tshirt"></i> Fashion</a>
        <a href="category.html?category=beauty"><i class="fas fa-heart"></i> Beauty</a>
        <a href="category.html?category=phones"><i class="fas fa-mobile-alt"></i> Phones</a>
        <a href="category.html?category=kitchenware"><i class="fas fa-blender"></i> Kitchenware</a>
        <a href="category.html?category=foodstuffs"><i class="fas fa-carrot"></i> Foodstuffs</a>
      </div>
    </div>
    <div class="mega-menu-section">
      <h4>Quick Links</h4>
      <div class="mega-menu-links">
        <a href="listing.html"><i class="fas fa-plus-circle"></i> Sell Product</a>
        <a href="orderTracking.html"><i class="fas fa-truck"></i> Track Orders</a>
        <a href="customer_care.html"><i class="fas fa-headset"></i> Help & Support</a>
      </div>
    </div>
  </div>

  <!-- Profile Hero -->
  <div class="profile-hero">
    <img src="images/profile-placeholder.png" alt="Profile" class="profile-pic" id="profile-pic" onclick="document.getElementById('profile-pic-input').click()">
    <input type="file" id="profile-pic-input" class="hidden-input" accept="image/*">
    <div class="profile-info">
      <div class="profile-name" id="user-name">Set Your Name</div>
      <div class="profile-email" id="user-email">Loading...</div>
      <div class="profile-location" id="user-location-display">
        <i class="fas fa-map-marker-alt"></i>
        <span id="location-text">Set your location</span>
      </div>
    </div>
    <button class="view-public-btn" id="viewProfileBtn">
      <i class="fas fa-external-link-alt"></i> View
    </button>
  </div>

  <!-- Stats -->
  <div class="stats-row">
    <div class="stat-item">
      <div class="stat-value" id="listings-count">0</div>
      <div class="stat-label">Listings</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="orders-count">0</div>
      <div class="stat-label">Orders</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="reviews-count">0</div>
      <div class="stat-label">Reviews</div>
    </div>
  </div>

  <!-- Profile Prompt -->
  <div class="profile-prompt" id="profile-prompt">
    <h4><i class="fas fa-user-edit"></i> Complete Your Profile</h4>
    <p>Add your name, phone and location to get the best experience on Oda Pap.</p>
    <button onclick="document.getElementById('edit-name-container').classList.add('active')">Complete Now</button>
  </div>

  <!-- Balance Card (Read-only Display) -->
  <div class="balance-card">
    <div class="balance-info">
      <h4>ðŸ’° Your Balance</h4>
      <div class="balance-amount" id="account-balance">KES 0.00</div>
      <small style="opacity: 0.8; font-size: 0.7rem;">Tap Deposit to add funds</small>
    </div>
    <a href="deposit.html" class="balance-toggle" style="text-decoration: none;">
      <i class="fas fa-plus"></i>
    </a>
  </div>

  <!-- Quick Actions -->
  <div class="quick-actions">
    <a href="seller-dashboard.html" class="quick-action">
      <i class="fas fa-chart-line"></i>
      <span>Seller Hub</span>
    </a>
    <a href="deposit.html" class="quick-action">
      <i class="fas fa-plus-circle"></i>
      <span>Deposit</span>
    </a>
    <a href="orderTracking.html" class="quick-action">
      <i class="fas fa-truck"></i>
      <span>Orders</span>
    </a>
    <a href="listing.html" class="quick-action">
      <i class="fas fa-store"></i>
      <span>Sell</span>
    </a>
  </div>

  <!-- Personal Info -->
  <div class="section-card">
    <div class="section-header">
      <h3><i class="fas fa-user"></i> Personal Info</h3>
    </div>
    <p style="font-size: 0.7rem; color: #888; padding: 8px 12px 0; margin: 0;">âœ… Keep your info updated so sellers can reach you easily</p>
    <div class="info-row">
      <div>
        <div class="info-label">Full Name</div>
        <div class="info-value" id="display-name">Not Set</div>
      </div>
      <button class="edit-btn" id="edit-name-button">Edit</button>
    </div>
    <div class="edit-container" id="edit-name-container">
      <input type="text" id="new-name-input" placeholder="Enter your name">
      <div class="edit-actions">
        <button class="btn-cancel" id="cancel-name-button">Cancel</button>
        <button class="btn-save" id="save-name-button">Save</button>
      </div>
    </div>
    <div class="info-row">
      <div>
        <div class="info-label">Phone Number</div>
        <div class="info-value" id="user-phone">Not Set</div>
      </div>
      <button class="edit-btn" id="edit-phone-button">Edit</button>
    </div>
    <div class="edit-container" id="edit-phone-container">
      <input type="tel" id="new-phone-input" placeholder="Enter phone number">
      <div class="edit-actions">
        <button class="btn-cancel" id="cancel-phone-button">Cancel</button>
        <button class="btn-save" id="save-phone-button">Save</button>
      </div>
    </div>
  </div>

  <!-- Location -->
  <div class="section-card">
    <div class="section-header">
      <h3><i class="fas fa-map-marker-alt"></i> Location</h3>
      <button class="edit-btn" id="edit-location-button">Edit</button>
    </div>
    <div class="info-row" id="location-summary">
      <div class="info-value" id="full-location-display">Not Set</div>
    </div>
    <!-- Cascading Dropdown Form (default) -->
    <div class="location-form" id="location-form">
      <button type="button" class="btn-detect-location" id="btn-detect-location">
        <i class="fas fa-crosshairs"></i> Detect My Location
      </button>
      <div id="detect-status" class="detect-status" style="display:none;"></div>
      <label for="region-select">Region</label>
      <select id="region-select"><option value="">Select Region</option></select>
      <label for="county-select">County</label>
      <select id="county-select" disabled><option value="">Select County</option></select>
      <label for="constituency-select">Constituency / Sub-County</label>
      <select id="constituency-select" disabled><option value="">Select Constituency</option></select>
      <label for="ward-select">Ward</label>
      <select id="ward-select" disabled><option value="">Select Ward</option></select>
      <label for="specific-location">Specific Location / Landmark</label>
      <textarea id="specific-location" rows="2" placeholder="e.g., Near Tuskys, 2nd floor"></textarea>
      <!-- Optional Map -->
      <div class="map-toggle" style="margin-top:10px;">
        <button type="button" class="btn-map-toggle" id="profile-map-toggle">
          <i class="fas fa-map-marked-alt"></i> Pin on Map (optional)
        </button>
      </div>
      <div id="profile-map-container" class="map-container" style="display:none;">
        <div id="profile-map" class="leaflet-map"></div>
        <p class="map-hint"><i class="fas fa-info-circle"></i> Tap the map to pin your location</p>
      </div>
      <div class="edit-actions" style="margin-top:10px;">
        <button class="btn-cancel" id="cancel-location-button">Cancel</button>
        <button class="btn-save" id="save-location-button">Save</button>
      </div>
    </div>
  </div>

  <!-- Seller Orders -->
  <div class="section-card">
    <div class="section-header">
      <h3><i class="fas fa-shopping-bag"></i> Seller Orders</h3>
    </div>
    <div class="orders-tabs">
      <button class="order-tab active" data-status="all"><span class="order-tab-count" id="all-orders-count">0</span>All</button>
      <button class="order-tab" data-status="pending"><span class="order-tab-count" id="pending-orders-count">0</span>Pending</button>
      <button class="order-tab" data-status="processing"><span class="order-tab-count" id="processing-orders-count">0</span>Processing</button>
      <button class="order-tab" data-status="shipped"><span class="order-tab-count" id="shipped-orders-count">0</span>Shipped</button>
      <button class="order-tab" data-status="delivered"><span class="order-tab-count" id="delivered-orders-count">0</span>Done</button>
    </div>
    <div class="orders-list" id="seller-orders-list">
      <div class="orders-empty"><i class="fas fa-box-open"></i>No orders yet</div>
    </div>
  </div>

  <!-- Menu Links -->
  <div class="menu-links">
    <!-- Admin & Delivery links â€” shown only for verified users -->
    <a href="admin.html" class="menu-link" id="adminDashboardLink" style="display:none; background: linear-gradient(135deg, #ede7f6, #e8eaf6);">
      <i class="fas fa-shield-alt" style="background:#ede7f6; color:#7c3aed;"></i>
      <span style="color:#5b21b6; font-weight:600;">Admin Dashboard</span>
      <i class="fas fa-chevron-right arrow" style="color:#7c3aed;"></i>
    </a>
    <a href="delivery.html" class="menu-link" id="deliveryDashboardLink" style="display:none; background: linear-gradient(135deg, #e0f2fe, #dbeafe);">
      <i class="fas fa-shipping-fast" style="background:#dbeafe; color:#0369a1;"></i>
      <span style="color:#0c4a6e; font-weight:600;">Delivery Dashboard</span>
      <i class="fas fa-chevron-right arrow" style="color:#0369a1;"></i>
    </a>
    <a href="recently_viewed.html" class="menu-link">
      <i class="fas fa-history"></i>
      <span>Recently Viewed</span>
      <i class="fas fa-chevron-right arrow"></i>
    </a>
    <a href="compare.html" class="menu-link">
      <i class="fas fa-columns"></i>
      <span>Compare Products</span>
      <i class="fas fa-chevron-right arrow"></i>
    </a>
    <a href="wishlist.html" class="menu-link">
      <i class="fas fa-heart"></i>
      <span>Wishlist</span>
      <i class="fas fa-chevron-right arrow"></i>
    </a>
    <a href="referral.html" class="menu-link" style="background: linear-gradient(135deg, #fff7f0, #fff3e0);">
      <i class="fas fa-gift" style="color: #ff5722;"></i>
      <span style="color: #e64a19; font-weight: 600;">Refer & Earn 5%</span>
      <i class="fas fa-chevron-right arrow" style="color: #ff5722;"></i>
    </a>
    <a href="seller-dashboard.html" class="menu-link">
      <i class="fas fa-store"></i>
      <span>My Shop</span>
      <i class="fas fa-chevron-right arrow"></i>
    </a>
    <a href="deposit.html" class="menu-link">
      <i class="fas fa-wallet"></i>
      <span>Deposit Funds</span>
      <i class="fas fa-chevron-right arrow"></i>
    </a>
    <a href="withdraw.html" class="menu-link">
      <i class="fas fa-money-bill-wave"></i>
      <span>Withdraw</span>
      <i class="fas fa-chevron-right arrow"></i>
    </a>
    <a href="orderTracking.html" class="menu-link">
      <i class="fas fa-truck"></i>
      <span>Track Orders</span>
      <i class="fas fa-chevron-right arrow"></i>
    </a>
    <a href="addresses.html" class="menu-link">
      <i class="fas fa-map-marker-alt"></i>
      <span>My Addresses</span>
      <i class="fas fa-chevron-right arrow"></i>
    </a>
    <a href="returns.html" class="menu-link">
      <i class="fas fa-undo-alt"></i>
      <span>Returns & Refunds</span>
      <i class="fas fa-chevron-right arrow"></i>
    </a>
    <a href="customer_care.html" class="menu-link">
      <i class="fas fa-headset"></i>
      <span>Help & Support</span>
      <i class="fas fa-chevron-right arrow"></i>
    </a>
    <a href="#" class="menu-link danger" id="logout-btn">
      <i class="fas fa-sign-out-alt"></i>
      <span>Logout</span>
      <i class="fas fa-chevron-right arrow"></i>
    </a>
  </div>

  <!-- Download App Banner -->
  <div class="download-app-banner" id="download-app-banner" style="display:none;">
    <div class="download-app-inner">
      <div class="download-app-icon">
        <img src="favicon_io/android-chrome-192x192.png" alt="Oda Pap" onerror="this.src='images/logo.png'">
      </div>
      <div class="download-app-text">
        <strong>Get Oda Pap App</strong>
        <span>Install for faster access â€¢ Only ~2MB</span>
      </div>
      <button class="download-app-btn" id="install-app-btn">
        <i class="fas fa-download"></i> Install
      </button>
    </div>
  </div>

  <script type="module">
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
    import { getFirestore, doc, updateDoc, getDoc, setDoc, collection, query, where, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-storage.js";
    import { app } from "./js/firebase.js";
    import { showNotification } from './notifications.js';
    import { counties } from './js/locationData.js';
    import { escapeHtml } from './js/sanitize.js';
    import { detectLocation } from './js/geolocation.js';

    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const EDIT_LOCK_DURATION = 24 * 60 * 60 * 1000;
    let currentUserId = null;
    let balanceVisible = true;
    
    // Seller orders state (moved to top to avoid hoisting issues)
    let allSellerOrders = [];
    let currentOrderFilter = 'all';

    // Toast notification function
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast-notification ${type}`;
      const iconName = type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle';
      const icon = document.createElement('i');
      icon.className = `fas fa-${iconName}`;
      const span = document.createElement('span');
      span.textContent = message;
      toast.appendChild(icon);
      toast.appendChild(span);
      toast.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#3b82f6'};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 10000;
        animation: slideIn 0.3s ease;
      `;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, 5000);
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      currentUserId = user.uid;
      await loadUserProfile(user);
      await loadUserStats(user.uid);
      await loadSellerOrders(user.uid);
      initOrderTabs();
      // Check admin & delivery staff status and show links
      checkVerifiedRoles(user);
      
      // Check for redirect message from listing page
      const redirectMessage = sessionStorage.getItem('profileMessage');
      if (redirectMessage) {
        sessionStorage.removeItem('profileMessage');
        showToast(redirectMessage, 'warning');
        // Scroll to profile prompt
        setTimeout(() => {
          const promptEl = document.getElementById('profile-prompt');
          if (promptEl && promptEl.style.display !== 'none') {
            promptEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }, 500);
      }
    });

    async function loadUserProfile(user) {
      const userDocRef = doc(db, "Users", user.uid);
      const userDoc = await getDoc(userDocRef);
      
      if (!userDoc.exists()) {
        await setDoc(userDocRef, {
          email: user.email,
          name: "",
          phone: "",
          profilePicUrl: "images/profile-placeholder.png",
          createdAt: new Date().toISOString()
        });
      }

      const userData = userDoc.data() || {};
      
      document.getElementById('profile-pic').src = userData.profilePicUrl || "images/profile-placeholder.png";
      document.getElementById('user-name').textContent = userData.name || "Set Your Name";
      document.getElementById('display-name').textContent = userData.name || "Not Set";
      document.getElementById('user-email').textContent = userData.email || user.email;
      document.getElementById('user-phone').textContent = userData.phone || "Not Set";
      
      // Collapsed location display
      const locationParts = [userData.ward, userData.constituency, userData.county].filter(Boolean);
      const locationText = locationParts.length > 0 ? locationParts.join(', ') : 'Set your location';
      document.getElementById('location-text').textContent = locationText;
      document.getElementById('full-location-display').textContent = locationParts.length > 0 
        ? [userData.specificLocation, ...locationParts, userData.region].filter(Boolean).join(', ')
        : 'Not Set';

      // Initialize location dropdowns with current data
      prefillLocationDropdowns({
        region: userData.region || '',
        county: userData.county || '',
        constituency: userData.constituency || '',
        ward: userData.ward || '',
        specificLocation: userData.specificLocation || ''
      });

      // If user has saved map coords, store them
      if (userData.lat && userData.lng) {
        profileMapMarkerCoords = { lat: userData.lat, lng: userData.lng };
      }

      const balance = userData.walletBalance || 0;
      document.getElementById('account-balance').textContent = `KES ${balance.toLocaleString()}`;

      // Show profile prompt if incomplete
      if (!userData.name || !userData.phone || !userData.county) {
        document.getElementById('profile-prompt').style.display = 'block';
      }

      ['name', 'phone'].forEach(updateEditButtonState);
    }

    async function loadUserStats(uid) {
      try {
        const listingsQuery = query(collection(db, "Listings"), where("uploaderId", "==", uid));
        const listingsSnap = await getDocs(listingsQuery);
        document.getElementById('listings-count').textContent = listingsSnap.size;

        const ordersQuery = query(collection(db, "Orders"), where("userId", "==", uid));
        const ordersSnap = await getDocs(ordersQuery);
        document.getElementById('orders-count').textContent = ordersSnap.size;
      } catch (e) {
        console.log('Stats error:', e);
      }
    }

    /**
     * Check if current user is admin or delivery staff and show respective dashboard links.
     * Queries Admins collection (by email) and DeliveryStaff/{uid} doc.
     */
    async function checkVerifiedRoles(user) {
      try {
        // Check admin status
        const adminQuery = query(collection(db, "Admins"), where("email", "==", user.email));
        const adminSnap = await getDocs(adminQuery);
        if (!adminSnap.empty) {
          const adminLink = document.getElementById('adminDashboardLink');
          if (adminLink) adminLink.style.display = 'flex';
        }

        // Check delivery staff status
        const deliveryDoc = await getDoc(doc(db, "DeliveryStaff", user.uid));
        if (deliveryDoc.exists()) {
          const deliveryLink = document.getElementById('deliveryDashboardLink');
          if (deliveryLink) deliveryLink.style.display = 'flex';
        }
      } catch (e) {
        // Silently fail â€” user just won't see the links
        console.log('Role check:', e.message);
      }
    }

    // View Public Profile
    document.getElementById('viewProfileBtn').addEventListener('click', () => {
      window.location.href = `user.html?userId=${currentUserId}`;
    });

    // Profile pic upload
    document.getElementById('profile-pic-input').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      // Validate file type
      const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
      if (!allowedTypes.includes(file.type)) {
        showNotification("Only JPEG, PNG, WebP and GIF images are allowed", "warning");
        e.target.value = '';
        return;
      }
      // Validate file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        showNotification("Image must be less than 5MB", "warning");
        e.target.value = '';
        return;
      }
      try {
        const ref = storageRef(storage, `profile-pics/${currentUserId}`);
        await uploadBytes(ref, file);
        const url = await getDownloadURL(ref);
        await updateDoc(doc(db, "Users", currentUserId), { profilePicUrl: url });
        document.getElementById('profile-pic').src = url;
        showNotification("Profile picture updated!");
      } catch (e) {
        showNotification("Failed to update picture", "error");
      }
    });

    // Name editing
    document.getElementById('edit-name-button').addEventListener('click', () => {
      if (isFieldLocked('name')) {
        showNotification(`Locked for ${getRemainingLockTime('name')}`, 'warning');
        return;
      }
      document.getElementById('edit-name-container').classList.add('active');
      document.getElementById('new-name-input').value = document.getElementById('display-name').textContent;
    });

    document.getElementById('save-name-button').addEventListener('click', async () => {
      const val = document.getElementById('new-name-input').value.trim();
      if (!val) {
        showNotification("Please enter a name", "warning");
        return;
      }
      if (val.length < 2 || val.length > 50) {
        showNotification("Name must be 2-50 characters", "warning");
        return;
      }
      // Block names with HTML/script injection patterns
      if (/<|>|script|javascript/i.test(val)) {
        showNotification("Invalid characters in name", "warning");
        return;
      }
      
      const saveBtn = document.getElementById('save-name-button');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Checking...';
      
      try {
        const usernameQuery = query(collection(db, "Users"), where("name", "==", val));
        const existingUsers = await getDocs(usernameQuery);
        
        let nameTaken = false;
        existingUsers.forEach(doc => {
          if (doc.id !== currentUserId) nameTaken = true;
        });
        
        if (nameTaken) {
          showNotification("Username already taken", "error");
          saveBtn.disabled = false;
          saveBtn.textContent = 'Save';
          return;
        }
        
        await updateDoc(doc(db, "Users", currentUserId), { name: val });
        document.getElementById('user-name').textContent = val;
        document.getElementById('display-name').textContent = val;
        lockField('name');
        document.getElementById('edit-name-container').classList.remove('active');
        document.getElementById('profile-prompt').style.display = 'none';
        showNotification("Name updated!");
      } catch (e) {
        showNotification("Error updating name", "error");
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save';
      }
    });

    document.getElementById('cancel-name-button').addEventListener('click', () => {
      document.getElementById('edit-name-container').classList.remove('active');
    });

    // Phone editing
    document.getElementById('edit-phone-button').addEventListener('click', () => {
      if (isFieldLocked('phone')) {
        showNotification(`Locked for ${getRemainingLockTime('phone')}`, 'warning');
        return;
      }
      document.getElementById('edit-phone-container').classList.add('active');
    });

    document.getElementById('save-phone-button').addEventListener('click', async () => {
      const val = document.getElementById('new-phone-input').value.trim();
      if (!val) {
        showNotification("Please enter a phone number", "warning");
        return;
      }
      // Validate phone: must be a Kenyan number format
      const phoneRegex = /^(?:\+?254|0)?[17]\d{8}$/;
      if (!phoneRegex.test(val.replace(/\s+/g, ''))) {
        showNotification("Enter a valid Kenyan phone number (e.g., 0712345678)", "warning");
        return;
      }
      try {
        await updateDoc(doc(db, "Users", currentUserId), { phone: val });
        document.getElementById('user-phone').textContent = val;
        lockField('phone');
        document.getElementById('edit-phone-container').classList.remove('active');
        showNotification("Phone updated!");
      } catch (e) {
        showNotification("Error updating phone", "error");
      }
    });

    document.getElementById('cancel-phone-button').addEventListener('click', () => {
      document.getElementById('edit-phone-container').classList.remove('active');
    });

    // Location editing - cascading dropdowns (default)
    const regionSelect = document.getElementById('region-select');
    const countySelect = document.getElementById('county-select');
    const constituencySelect = document.getElementById('constituency-select');
    const wardSelect = document.getElementById('ward-select');
    const specificLocationInput = document.getElementById('specific-location');
    const locationForm = document.getElementById('location-form');

    // Populate regions from locationData
    Object.keys(counties).forEach(region => {
      const opt = document.createElement('option');
      opt.value = region;
      opt.textContent = region.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
      regionSelect.appendChild(opt);
    });

    regionSelect.addEventListener('change', () => {
      const region = regionSelect.value;
      countySelect.innerHTML = '<option value="">Select County</option>';
      constituencySelect.innerHTML = '<option value="">Select Constituency</option>';
      wardSelect.innerHTML = '<option value="">Select Ward</option>';
      countySelect.disabled = !region;
      constituencySelect.disabled = true;
      wardSelect.disabled = true;
      if (region && counties[region]) {
        Object.keys(counties[region]).forEach(county => {
          const opt = document.createElement('option');
          opt.value = county;
          opt.textContent = county;
          countySelect.appendChild(opt);
        });
      }
    });

    countySelect.addEventListener('change', () => {
      const region = regionSelect.value;
      const county = countySelect.value;
      constituencySelect.innerHTML = '<option value="">Select Constituency</option>';
      wardSelect.innerHTML = '<option value="">Select Ward</option>';
      constituencySelect.disabled = !county;
      wardSelect.disabled = true;
      if (region && county && counties[region][county]) {
        Object.keys(counties[region][county]).forEach(cons => {
          const opt = document.createElement('option');
          opt.value = cons;
          opt.textContent = cons;
          constituencySelect.appendChild(opt);
        });
      }
    });

    constituencySelect.addEventListener('change', () => {
      const region = regionSelect.value;
      const county = countySelect.value;
      const cons = constituencySelect.value;
      wardSelect.innerHTML = '<option value="">Select Ward</option>';
      wardSelect.disabled = !cons;
      if (region && county && cons && counties[region][county][cons]) {
        counties[region][county][cons].forEach(ward => {
          const opt = document.createElement('option');
          opt.value = ward;
          opt.textContent = ward;
          wardSelect.appendChild(opt);
        });
      }
    });

    // Pre-fill dropdowns with saved data
    function prefillLocationDropdowns(data) {
      if (data.region) {
        regionSelect.value = data.region;
        regionSelect.dispatchEvent(new Event('change'));
        setTimeout(() => {
          if (data.county) {
            countySelect.value = data.county;
            countySelect.dispatchEvent(new Event('change'));
            setTimeout(() => {
              if (data.constituency) {
                constituencySelect.value = data.constituency;
                constituencySelect.dispatchEvent(new Event('change'));
                setTimeout(() => {
                  if (data.ward) wardSelect.value = data.ward;
                }, 10);
              }
            }, 10);
          }
        }, 10);
      }
      if (data.specificLocation) specificLocationInput.value = data.specificLocation;
    }

    // Detect My Location
    document.getElementById('btn-detect-location').addEventListener('click', async () => {
      const btn = document.getElementById('btn-detect-location');
      const status = document.getElementById('detect-status');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Detecting...';
      status.style.display = 'flex';
      status.className = 'detect-status loading';
      status.innerHTML = '<i class="fas fa-satellite-dish"></i> Requesting your locationâ€¦';
      try {
        const loc = await detectLocation();
        status.className = 'detect-status success';
        status.innerHTML = `<i class="fas fa-check-circle"></i> Found: ${loc.display_name.substring(0, 80)}â€¦`;
        // Try to match to our location data
        matchDetectedToDropdowns(loc);
        // Store coords for map
        profileMapMarkerCoords = { lat: loc.lat, lng: loc.lng };
        if (profileMap) {
          profileMap.setView([loc.lat, loc.lng], 14);
          if (profileMapMarker) profileMap.removeLayer(profileMapMarker);
          profileMapMarker = L.marker([loc.lat, loc.lng]).addTo(profileMap);
        }
        specificLocationInput.value = [loc.road, loc.ward, loc.subcounty].filter(Boolean).join(', ');

        // Auto-save after detection â€” wait briefly for dropdown cascades to settle
        setTimeout(async () => {
          try {
            const data = {
              region: regionSelect.value,
              county: countySelect.value,
              constituency: constituencySelect.value,
              ward: wardSelect.value,
              specificLocation: specificLocationInput.value.trim()
            };
            if (profileMapMarkerCoords) {
              data.lat = profileMapMarkerCoords.lat;
              data.lng = profileMapMarkerCoords.lng;
            }
            if (data.county) {
              await updateDoc(doc(db, "Users", currentUserId), data);
              const locationParts = [data.ward, data.constituency, data.county].filter(Boolean);
              document.getElementById('location-text').textContent = locationParts.join(', ');
              document.getElementById('full-location-display').textContent =
                [data.specificLocation, ...locationParts, data.region ? data.region.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ') : ''].filter(Boolean).join(', ');
              document.getElementById('profile-prompt').style.display = 'none';
              locationForm.classList.remove('active');
              status.className = 'detect-status success';
              status.innerHTML = '<i class="fas fa-check-circle"></i> Location detected & saved!';
              showNotification('Location detected & saved!', 'success');
            } else {
              // Dropdowns didn't match â€” show save button
              const saveBtn = document.getElementById('save-location-button');
              saveBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
              saveBtn.style.animation = 'pulse 0.6s ease 2';
              status.innerHTML += ' â€” Please verify & tap <strong>Save</strong> below.';
            }
          } catch (e) {
            // Auto-save failed, prompt manual save
            const saveBtn = document.getElementById('save-location-button');
            saveBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
            status.innerHTML += ' â€” Tap <strong>Save</strong> below to confirm.';
          }
        }, 500);
      } catch (e) {
        status.className = 'detect-status error';
        status.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${e.message}`;
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-crosshairs"></i> Detect My Location';
      }
    });

    function matchDetectedToDropdowns(loc) {
      // Best-effort fuzzy match of detected county name against our data
      const detected = (loc.county || '').toLowerCase();
      for (const [regionKey, regionCounties] of Object.entries(counties)) {
        for (const countyName of Object.keys(regionCounties)) {
          if (detected.includes(countyName.toLowerCase()) || countyName.toLowerCase().includes(detected)) {
            regionSelect.value = regionKey;
            regionSelect.dispatchEvent(new Event('change'));
            setTimeout(() => {
              countySelect.value = countyName;
              countySelect.dispatchEvent(new Event('change'));
              // Try matching sub-county
              const detSub = (loc.subcounty || '').toLowerCase();
              setTimeout(() => {
                for (const opt of constituencySelect.options) {
                  if (opt.value && detSub.includes(opt.value.toLowerCase())) {
                    constituencySelect.value = opt.value;
                    constituencySelect.dispatchEvent(new Event('change'));
                    // Try ward
                    const detWard = (loc.ward || '').toLowerCase();
                    setTimeout(() => {
                      for (const wo of wardSelect.options) {
                        if (wo.value && detWard.includes(wo.value.toLowerCase())) {
                          wardSelect.value = wo.value;
                          break;
                        }
                      }
                    }, 20);
                    break;
                  }
                }
              }, 20);
            }, 20);
            return;
          }
        }
      }
    }

    document.getElementById('edit-location-button').addEventListener('click', () => {
      locationForm.classList.toggle('active');
    });

    document.getElementById('cancel-location-button').addEventListener('click', () => {
      locationForm.classList.remove('active');
    });

    document.getElementById('save-location-button').addEventListener('click', async () => {
      const data = {
        region: regionSelect.value,
        county: countySelect.value,
        constituency: constituencySelect.value,
        ward: wardSelect.value,
        specificLocation: specificLocationInput.value.trim()
      };
      if (!data.county) {
        showNotification('Please select at least a county', 'warning');
        return;
      }
      // Include map coords if set
      if (profileMapMarkerCoords) {
        data.lat = profileMapMarkerCoords.lat;
        data.lng = profileMapMarkerCoords.lng;
      }
      try {
        await updateDoc(doc(db, "Users", currentUserId), data);
        const locationParts = [data.ward, data.constituency, data.county].filter(Boolean);
        document.getElementById('location-text').textContent = locationParts.join(', ');
        document.getElementById('full-location-display').textContent =
          [data.specificLocation, ...locationParts, data.region ? data.region.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ') : ''].filter(Boolean).join(', ');
        document.getElementById('profile-prompt').style.display = 'none';
        locationForm.classList.remove('active');
        showNotification("Location updated!");
      } catch (e) {
        showNotification("Failed to update location", "error");
      }
    });

    // Optional map for profile
    let profileMap = null;
    let profileMapMarker = null;
    let profileMapMarkerCoords = null;

    document.getElementById('profile-map-toggle').addEventListener('click', () => {
      const container = document.getElementById('profile-map-container');
      const isHidden = container.style.display === 'none';
      container.style.display = isHidden ? 'block' : 'none';
      if (isHidden && !profileMap) {
        initProfileMap();
      } else if (isHidden && profileMap) {
        setTimeout(() => profileMap.invalidateSize(), 100);
      }
    });

    function initProfileMap() {
      profileMap = L.map('profile-map').setView([-1.2921, 36.8219], 7);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap'
      }).addTo(profileMap);
      profileMap.on('click', (e) => {
        const { lat, lng } = e.latlng;
        if (profileMapMarker) profileMap.removeLayer(profileMapMarker);
        profileMapMarker = L.marker([lat, lng]).addTo(profileMap);
        profileMapMarkerCoords = { lat, lng };
      });
      setTimeout(() => profileMap.invalidateSize(), 200);
    }

    // Logout
    document.getElementById('logout-btn').addEventListener('click', async (e) => {
      e.preventDefault();
      // Show logout confirmation modal
      const modal = document.createElement('div');
      modal.className = 'logout-modal-overlay';
      modal.innerHTML = `
        <div class=\"logout-modal\" style=\"position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;\" onclick=\"if(event.target===this)this.remove()\">
          <div style=\"background:white;padding:24px;border-radius:16px;max-width:320px;text-align:center;\">
            <i class=\"fas fa-sign-out-alt\" style=\"font-size:48px;color:#ff5722;margin-bottom:16px;\"></i>
            <h3 style=\"margin:0 0 8px;color:#333;\">Logout</h3>
            <p style=\"color:#666;font-size:14px;margin:0 0 20px;\">Are you sure you want to logout?</p>
            <div style=\"display:flex;gap:12px;\">
              <button onclick=\"this.closest('.logout-modal').remove()\" style=\"flex:1;padding:12px;border:1px solid #ddd;background:white;border-radius:8px;cursor:pointer;font-weight:500;\">Cancel</button>
              <button id=\"confirmLogoutBtn\" style=\"flex:1;padding:12px;border:none;background:#ff5722;color:white;border-radius:8px;cursor:pointer;font-weight:500;\">Logout</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      document.getElementById('confirmLogoutBtn').addEventListener('click', async () => {
        await signOut(auth);
        window.location.href = 'login.html';
      });
    });

    // Lock helpers
    function isFieldLocked(f) {
      const d = localStorage.getItem(`editLock_${f}`);
      return d && (Date.now() - JSON.parse(d).timestamp < EDIT_LOCK_DURATION);
    }

    function getRemainingLockTime(f) {
      const d = localStorage.getItem(`editLock_${f}`);
      if (!d) return null;
      const rem = EDIT_LOCK_DURATION - (Date.now() - JSON.parse(d).timestamp);
      return `${Math.floor(rem/3600000)}h ${Math.floor((rem%3600000)/60000)}m`;
    }

    function lockField(f) {
      localStorage.setItem(`editLock_${f}`, JSON.stringify({ timestamp: Date.now() }));
      updateEditButtonState(f);
    }

    function updateEditButtonState(f) {
      const btn = document.getElementById(`edit-${f}-button`);
      if (!btn) return;
      if (isFieldLocked(f)) {
        btn.disabled = true;
        btn.textContent = `Locked`;
      } else {
        btn.disabled = false;
        btn.textContent = 'Edit';
      }
    }

    // Seller Orders
    async function loadSellerOrders(uid) {
      try {
        const ordersQuery = query(collection(db, "Orders"), where("sellerId", "==", uid));
        const snapshot = await getDocs(ordersQuery);
        allSellerOrders = [];
        snapshot.forEach(doc => {
          allSellerOrders.push({ id: doc.id, ...doc.data() });
        });
        allSellerOrders.sort((a, b) => {
          const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
          const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
          return dateB - dateA;
        });
        updateOrderCounts();
        renderSellerOrders();
      } catch (e) {
        console.log('Orders error:', e);
      }
    }

    function updateOrderCounts() {
      const counts = { all: allSellerOrders.length, pending: 0, processing: 0, shipped: 0, delivered: 0 };
      allSellerOrders.forEach(order => {
        const status = (order.status || 'pending').toLowerCase();
        if (counts.hasOwnProperty(status)) counts[status]++;
      });
      document.getElementById('all-orders-count').textContent = counts.all;
      document.getElementById('pending-orders-count').textContent = counts.pending;
      document.getElementById('processing-orders-count').textContent = counts.processing;
      document.getElementById('shipped-orders-count').textContent = counts.shipped;
      document.getElementById('delivered-orders-count').textContent = counts.delivered;
    }

    function renderSellerOrders() {
      const container = document.getElementById('seller-orders-list');
      let filteredOrders = currentOrderFilter === 'all' ? allSellerOrders 
        : allSellerOrders.filter(o => (o.status || o.orderStatus || 'pending').toLowerCase() === currentOrderFilter);

      if (filteredOrders.length === 0) {
        container.innerHTML = `<div class="orders-empty"><i class="fas fa-box-open"></i>No ${currentOrderFilter === 'all' ? '' : currentOrderFilter} orders</div>`;
        return;
      }

      let html = '';
      filteredOrders.slice(0, 8).forEach(order => {
        const status = order.status || order.orderStatus || 'pending';
        const total = order.totalAmount || order.total || 0;
        const orderId = (order.orderId || order.id).slice(-6).toUpperCase();
        const buyerName = order.buyerDetails?.name || 'Customer';
        const buyerPhone = order.buyerDetails?.phone || '';
        const orderDate = order.createdAt?.toDate?.() || (order.createdAt ? new Date(order.createdAt) : new Date());
        const items = order.items || [];
        const totalQty = items.reduce((sum, i) => sum + (i.quantity || 1), 0);

        // Build items preview (show up to 3 items)
        const itemsHtml = items.slice(0, 3).map(item => {
          const name = escapeHtml(item.productName || item.name || 'Product');
          const image = item.imageUrl || item.image || 'images/product-placeholder.png';
          const qty = item.quantity || 1;
          const price = item.pricePerUnit || item.price || 0;
          const variation = item.selectedVariation;
          const variantText = variation ? escapeHtml(typeof variation === 'object' ? `${variation.title || ''}: ${variation.attr_name || variation.value || ''}` : variation) : '';
          
          return `
            <div class="order-item-row">
              <img src="${image}" class="order-item-img" onerror="this.src='images/product-placeholder.png'" alt="${name}">
              <div class="order-item-details">
                <div class="order-item-name">${name}</div>
                ${variantText ? `<span class="order-item-variant">${variantText}</span>` : ''}
                <div class="order-item-qty">Qty: ${qty} Ã— KES ${price.toLocaleString()}</div>
              </div>
              <div class="order-item-price">KES ${(price * qty).toLocaleString()}</div>
            </div>
          `;
        }).join('');

        const moreItems = items.length > 3 ? `<div style="font-size:0.7rem;color:#666;text-align:center;padding:4px;">+${items.length - 3} more item(s)</div>` : '';

        html += `
          <div class="order-card" style="cursor: pointer;" onclick="showOrderDetails('${escapeHtml(order.id)}')">
            <div class="order-card-header">
              <span class="order-id">#${orderId} â€¢ ${orderDate.toLocaleDateString()}</span>
              <span class="order-status ${status.toLowerCase()}">${escapeHtml(status)}</span>
            </div>
            <div class="order-card-body">
              <div class="order-items-preview">
                ${itemsHtml}
                ${moreItems}
              </div>
              <div class="order-summary-row">
                <span class="order-buyer-info"><i class="fas fa-user"></i> ${escapeHtml(buyerName)} ${buyerPhone ? 'â€¢ ' + escapeHtml(buyerPhone) : ''}</span>
                <span class="order-total">${totalQty} item(s) â€¢ KES ${total.toLocaleString()}</span>
              </div>
            </div>
            ${renderOrderActions(order)}
          </div>
        `;
      });
      container.innerHTML = html;

      container.querySelectorAll('.btn-accept').forEach(btn => {
        btn.addEventListener('click', () => updateOrderStatus(btn.dataset.orderId, 'processing'));
      });
      container.querySelectorAll('.btn-ship').forEach(btn => {
        btn.addEventListener('click', () => updateOrderStatus(btn.dataset.orderId, 'shipped'));
      });
      container.querySelectorAll('.btn-complete').forEach(btn => {
        btn.addEventListener('click', () => updateOrderStatus(btn.dataset.orderId, 'delivered'));
      });
      container.querySelectorAll('.btn-cancel-order').forEach(btn => {
        btn.addEventListener('click', () => {
          // Show cancel confirmation modal
          const orderId = btn.dataset.orderId;
          const overlay = document.createElement('div');
          overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;';
          overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });

          const box = document.createElement('div');
          box.style.cssText = 'background:white;padding:24px;border-radius:16px;max-width:320px;text-align:center;';
          box.innerHTML = `
            <i class="fas fa-times-circle" style="font-size:48px;color:#f44336;margin-bottom:16px;"></i>
            <h3 style="margin:0 0 8px;color:#333;">Cancel Order</h3>
            <p style="color:#666;font-size:14px;margin:0 0 20px;">Are you sure you want to cancel this order?</p>
            <div style="display:flex;gap:12px;">
              <button class="cancel-no" style="flex:1;padding:12px;border:1px solid #ddd;background:white;border-radius:8px;cursor:pointer;">No, Keep</button>
              <button class="cancel-yes" style="flex:1;padding:12px;border:none;background:#f44336;color:white;border-radius:8px;cursor:pointer;">Cancel Order</button>
            </div>
          `;
          box.querySelector('.cancel-no').addEventListener('click', () => overlay.remove());
          box.querySelector('.cancel-yes').addEventListener('click', () => {
            updateOrderStatus(orderId, 'cancelled');
            overlay.remove();
          });

          overlay.appendChild(box);
          document.body.appendChild(overlay);
        });
      });
    }

    function renderOrderActions(order) {
      const status = (order.status || order.orderStatus || 'pending').toLowerCase();
      const safeId = escapeHtml(order.id);
      if (status === 'pending') {
        return `<div class="order-actions">
          <button class="order-action-btn btn-accept" data-order-id="${safeId}" onclick="event.stopPropagation();">Accept</button>
          <button class="order-action-btn btn-cancel-order" data-order-id="${safeId}" onclick="event.stopPropagation();">Cancel</button>
        </div>`;
      } else if (status === 'processing' || status === 'confirmed' || status === 'seller_confirmed') {
        return `<div class="order-actions">
          <button class="order-action-btn btn-ship" data-order-id="${safeId}" onclick="event.stopPropagation();">Ship</button>
        </div>`;
      } else if (status === 'shipped' || status === 'out_for_delivery') {
        return `<div class="order-actions">
          <button class="order-action-btn btn-complete" data-order-id="${safeId}" onclick="event.stopPropagation();">Complete</button>
        </div>`;
      }
      return '';
    }

    // Show order details modal
    window.showOrderDetails = function(orderId) {
      const order = allSellerOrders.find(o => o.id === orderId);
      if (!order) return;
      
      const modal = document.createElement('div');
      modal.className = 'order-modal-overlay';
      modal.innerHTML = `
        <div class="order-modal-content">
          <div class="order-modal-header">
            <h3><i class="fas fa-shopping-bag"></i> Order #${escapeHtml((order.orderId || order.id).slice(-8).toUpperCase())}</h3>
            <button class="order-modal-close"><i class="fas fa-times"></i></button>
          </div>
          <div class="order-modal-body">
            <div class="order-detail-section">
              <h4>Buyer Details</h4>
              <p><strong>${escapeHtml(order.buyerDetails?.name || 'N/A')}</strong></p>
              <p><i class="fas fa-phone"></i> ${escapeHtml(order.buyerDetails?.phone || order.mpesaPhone || 'N/A')}</p>
              <p><i class="fas fa-map-marker-alt"></i> ${escapeHtml(order.buyerDetails?.location || 'N/A')}</p>
              <p><i class="fas fa-home"></i> ${escapeHtml(order.buyerDetails?.deliveryAddress || 'N/A')}</p>
            </div>
            <div class="order-detail-section">
              <h4>Items Sold (${order.items?.length || 0})</h4>
              ${order.items?.map(item => {
                const name = escapeHtml(item.productName || item.name || 'Product');
                const qty = item.quantity || 1;
                const price = item.pricePerUnit || item.price || 0;
                const variation = item.selectedVariation;
                let variantDisplay = '';
                if (variation) {
                  if (typeof variation === 'object') {
                    variantDisplay = `<div style="background:#fff3e0;color:#ff5722;padding:3px 8px;border-radius:4px;font-size:0.75rem;margin:4px 0;"><i class="fas fa-tag"></i> ${escapeHtml(variation.title || 'Variant')}: ${escapeHtml(variation.attr_name || variation.value || '')}</div>`;
                  } else {
                    variantDisplay = `<div style="background:#fff3e0;color:#ff5722;padding:3px 8px;border-radius:4px;font-size:0.75rem;margin:4px 0;"><i class="fas fa-tag"></i> ${escapeHtml(variation)}</div>`;
                  }
                }
                return `
                <div class="order-detail-item" style="background:#f9f9f9;padding:10px;border-radius:8px;margin-bottom:8px;">
                  <img src="${item.imageUrl || 'images/product-placeholder.png'}" alt="${name}" onerror="this.src='images/product-placeholder.png'" style="width:50px;height:50px;border-radius:6px;object-fit:cover;">
                  <div class="order-detail-item-info" style="flex:1;margin-left:10px;">
                    <strong style="font-size:0.85rem;">${name}</strong>
                    ${variantDisplay}
                    <div style="font-size:0.8rem;color:#666;"><i class="fas fa-box"></i> Qty: <strong>${qty}</strong> Ã— KES ${price.toLocaleString()}</div>
                  </div>
                  <div class="order-detail-item-price" style="font-weight:700;color:#333;">KES ${(price * qty).toLocaleString()}</div>
                </div>
              `;
              }).join('') || '<p>No item details</p>'}
            </div>
            <div class="order-detail-section">
              <h4>Payment</h4>
              <p>Method: <strong>${escapeHtml(order.paymentMethod || 'N/A')}</strong></p>
              <p>Status: <span class="order-status ${escapeHtml(order.paymentStatus || 'pending')}">${escapeHtml(order.paymentStatus || 'pending')}</span></p>
              ${order.mpesaTransactionId ? `<p>M-Pesa: ${escapeHtml(order.mpesaTransactionId)}</p>` : ''}
            </div>
            <div class="order-detail-totals">
              <div><span>Subtotal</span><span>KES ${(order.subtotal || 0).toLocaleString()}</span></div>
              <div><span>Shipping</span><span>KES ${(order.shippingFee || 0).toLocaleString()}</span></div>
              ${order.discount ? `<div><span>Discount</span><span>-KES ${order.discount.toLocaleString()}</span></div>` : ''}
              <div class="total-row"><span>Total</span><span>KES ${(order.totalAmount || 0).toLocaleString()}</span></div>
            </div>
          </div>
        </div>
      `;
      modal.querySelector('.order-modal-close').addEventListener('click', () => modal.remove());
      document.body.appendChild(modal);
      modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
    };

    async function updateOrderStatus(orderId, newStatus) {
      try {
        await updateDoc(doc(db, "Orders", orderId), { status: newStatus, updatedAt: new Date().toISOString() });
        const idx = allSellerOrders.findIndex(o => o.id === orderId);
        if (idx !== -1) allSellerOrders[idx].status = newStatus;
        updateOrderCounts();
        renderSellerOrders();
        showNotification(`Order ${newStatus}!`);
      } catch (e) {
        showNotification("Failed to update order", "error");
      }
    }

    function initOrderTabs() {
      document.querySelectorAll('.order-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.order-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentOrderFilter = tab.dataset.status;
          renderSellerOrders();
        });
      });
    }

    // Menu toggle functions
    window.toggleOdaMenu = function() {
      document.getElementById('odaMenuOverlay').classList.add('open');
      document.getElementById('odaMegaMenu').classList.add('open');
      document.body.style.overflow = 'hidden';
    };
    window.closeOdaMenu = function() {
      document.getElementById('odaMenuOverlay').classList.remove('open');
      document.getElementById('odaMegaMenu').classList.remove('open');
      document.body.style.overflow = '';
    };
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeOdaMenu(); });

    // ===== PWA Install (Download App) =====
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      const banner = document.getElementById('download-app-banner');
      if (banner) banner.style.display = 'block';
    });

    document.getElementById('install-app-btn')?.addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const result = await deferredPrompt.userChoice;
        if (result.outcome === 'accepted') {
          showToast('App installing! Check your home screen.', 'success');
          document.getElementById('download-app-banner').style.display = 'none';
        }
        deferredPrompt = null;
      } else {
        // Fallback: show manual instructions
        showToast('Tap your browser menu (â‹®) â†’ "Add to Home Screen" to install', 'info');
      }
    });

    // Show banner if already installed (standalone) â†’ hide it
    if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
      const banner = document.getElementById('download-app-banner');
      if (banner) banner.style.display = 'none';
    }
  </script>
</body>
</html>
