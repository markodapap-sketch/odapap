<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/jpeg" href="images/logo.jpg">
    <link rel="apple-touch-icon" href="images/logo.jpg">
    <title>Notifications - Chat History</title>
    <link rel="stylesheet" href="notifications.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
</head>
<body>
    <header>
        <div class="top-bar"></div>
        <div class="logo-container">
            <img src="images/logo.jpg" alt="Oda Pap Logo" class="logo">
            <span class="logo-text">Oda Pap</span>
        </div>
        <div class="border-line"></div>
        <div class="nav-bar" id="nav-bar">
            <button class="home-button" onclick="location.href='index.html'"><i class="fas fa-home"></i></button>
            <button class="home-button" onclick="location.href='notification.html'"><i class="fas fa-bell" id="notification-icon"></i></button>
            <button class="home-button" onclick="location.href='cart.html'"><i class="fas fa-shopping-cart"></i></button>
            <button class="home-button" onclick="location.href='profile.html'"><i class="fas fa-user-circle"></i></button>
        </div>
    </header>
    <main>
        <div id="chat-container" class="chat-container">
            <!-- Chat messages will be dynamically added here -->
        </div>
    </main>
    <div class="notification-container">
        <div class="notification-header">
            <h1>Chats</h1>
        </div>
        <ul id="notification-list" class="notification-list">
            <!-- Chat items will be dynamically populated here -->
        </ul>
    </div>
    <footer>
        <button class="floating-button" onclick="location.href='customercare.html'">
            <i class="fas fa-headset"></i>
            <span class="button-text">Customer Care</span>
        </button>
    </footer>
    <script type="module">
        import { app } from "./js/firebase.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, getDoc, or } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { showNotification } from './notifications.js';
        const auth = getAuth(app);
        const firestore = getFirestore(app);

        const notificationList = document.getElementById("notification-list");

        // Function to display chat history item
        async function displayChat(chatData) {
            const chatItem = document.createElement("li");
            chatItem.classList.add("notification-item");

            // Get profile picture of the seller/buyer
            let profilePicUrl = "images/profile-placeholder.png";
            if (chatData.profilePic) {
                profilePicUrl = chatData.profilePic;
            }

            chatItem.innerHTML = `
                <div class="chat-item">
                    <div class="profile-picture">
                        <img src="${profilePicUrl}" alt="Profile Picture" class="profile-img" onclick="goToUserProfile('${chatData.sellerId}')">
                    </div>
                    <div class="chat-details">
                        <p class="chat-name">${chatData.sellerName}</p>
                        <p class="chat-message">${chatData.lastMessage}</p>
                    </div>
                    <div class="chat-time">
                        <small>${new Date(chatData.timestamp.seconds * 1000).toLocaleString()}</small>
                    </div>
                </div>
            `;

            // Handle redirection to chat page
            chatItem.onclick = function () {
                window.location.href = `chat.html?sellerId=${chatData.sellerId}`;
            };

            notificationList.appendChild(chatItem);
        }

        // Function to redirect to user profile page
        window.goToUserProfile = function(userId) {
            window.location.href = `user.html?userId=${userId}`;
        };

        // Listen for authentication changes
        auth.onAuthStateChanged((user) => {
            if (user) {
                loadChats(user.uid);
            } else {
                showNotification("Please log in to view your chats.");
                window.location.href = "login.html";
            }
        });

        // Load chat history for the user
        async function loadChats(userId) {
            const chatRef = collection(firestore, "Messages");
            const chatQuery = query(chatRef, or(where("buyerId", "==", userId), where("sellerId", "==", userId)));

            onSnapshot(chatQuery, async (snapshot) => {
                notificationList.innerHTML = ""; // Clear previous chats
                const chatGroups = {};
                snapshot.forEach((docSnap) => {
                    const chatData = docSnap.data();
                    const otherUserId = chatData.buyerId === userId ? chatData.sellerId : chatData.buyerId;
                    if (!chatGroups[otherUserId]) {
                        chatGroups[otherUserId] = [];
                    }
                    chatGroups[otherUserId].push(chatData);
                });

                for (const otherUserId in chatGroups) {
                    const chatData = chatGroups[otherUserId][0];
                    const otherUserDoc = await getDoc(doc(firestore, "Users", otherUserId));
                    const otherUserData = otherUserDoc.exists() ? otherUserDoc.data() : { name: "Unknown User" };
                    let profilePicUrl = "images/profile-placeholder.png";
                    if (otherUserData.profilePicUrl) {
                        profilePicUrl = otherUserData.profilePicUrl;
                    }
                    displayChat({
                        sellerId: chatData.sellerId,
                        sellerName: otherUserData.name,
                        profilePic: profilePicUrl,
                        lastMessage: chatData.message || "No messages yet.",
                        timestamp: chatData.timestamp
                    });
                }
            });
        }

        // Real-time listener for messages
        function listenForMessages() {
            const user = auth.currentUser;
            if (!user) return;

            const q = query(collection(firestore, "Messages"), where("recipientId", "==", user.uid));
            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const message = change.doc.data();
                        showNotification(`New message from ${message.senderId}`);
                        updateChatInterface(message);
                    }
                });
            });
        }

        // Function to update chat interface
        function updateChatInterface(message) {
            const chatContainer = document.getElementById('chat-container');
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message';
            messageElement.innerHTML = `
                <div class="message-bubble">
                    <p>${message.message}</p>
                    <span class="timestamp">${new Date(message.timestamp).toLocaleTimeString()}</span>
                </div>
            `;
            chatContainer.appendChild(messageElement);
        }

        // Function to update notification count
        function updateNotificationCount() {
            const user = auth.currentUser;
            if (!user) return;

            const q = query(collection(firestore, "Messages"), where("recipientId", "==", user.uid), where("status", "==", "sent"));
            onSnapshot(q, (snapshot) => {
                const unreadCount = snapshot.size;
                const notificationIcon = document.getElementById('notification-icon');
                notificationIcon.textContent = unreadCount;
            });
        }
    </script>
</body>
</html>