<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="favicon_io/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="favicon_io/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="favicon_io/favicon-16x16.png"><link rel="manifest" href="favicon_io/site.webmanifest">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon_io/apple-touch-icon.png">
    <title>My Addresses - Oda Pap</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="css/header.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header class="oda-header">
        <div class="header-top-bar">
            <div class="header-logo" onclick="location.href='index.html'">
                <img src="images/logo.png" alt="Oda Pap" class="header-logo-img">
                <span class="header-logo-text">Oda Pap</span>
            </div>
            <button onclick="window.history.back()" class="header-back-btn">
                <i class="fas fa-arrow-left"></i> Back
            </button>
        </div>
        <div class="header-divider"></div>
        <nav class="header-nav">
            <button class="header-nav-btn" onclick="location.href='index.html'"><i class="fas fa-home"></i></button>
            <button class="header-nav-btn" onclick="location.href='notification.html'"><i class="fas fa-bell"></i></button>
            <button class="header-nav-btn" onclick="location.href='cart.html'"><i class="fas fa-shopping-cart"></i></button>
            <button class="header-nav-btn" onclick="location.href='wishlist.html'"><i class="fas fa-heart"></i></button>
            <button class="header-nav-btn" onclick="location.href='profile.html'"><i class="fas fa-user-circle"></i></button>
        </nav>
    </header>

    <main>
        <div class="page-header">
            <h1><i class="fas fa-map-marker-alt"></i> My Addresses</h1>
            <p>Manage your delivery addresses</p>
            <p style="font-size: 0.75rem; color: rgba(255,255,255,0.8); margin-top: 6px;">üìç Save addresses for faster checkout. Set one as default!</p>
        </div>

        <div class="addr-container">
            <div class="addr-actions-bar">
                <span class="addr-count" id="addrCount">0 saved addresses</span>
                <button class="addr-add-btn" id="addAddressBtn">
                    <i class="fas fa-plus"></i> Add Address
                </button>
            </div>

            <div id="addressesList" class="addr-list">
                <!-- Addresses loaded dynamically -->
            </div>

            <div id="emptyState" class="addr-empty" style="display:none;">
                <i class="fas fa-map-marked-alt"></i>
                <h3>No saved addresses</h3>
                <p>Add an address for faster checkout</p>
                <button class="addr-add-btn" onclick="document.getElementById('addAddressBtn').click()">
                    <i class="fas fa-plus"></i> Add Your First Address
                </button>
            </div>
        </div>
    </main>

    <!-- Add/Edit Address Modal -->
    <div id="addressModal" class="addr-modal-overlay" style="display:none;">
        <div class="addr-modal">
            <div class="addr-modal-header">
                <h2 id="modalTitle"><i class="fas fa-plus-circle"></i> Add Address</h2>
                <button class="addr-modal-close" onclick="closeAddressModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="addr-modal-body">
                <form id="addressForm">
                    <div class="addr-form-group">
                        <label><i class="fas fa-tag"></i> Label *</label>
                        <div class="addr-label-chips">
                            <label class="addr-chip selected"><input type="radio" name="addrLabel" value="Home" checked><i class="fas fa-home"></i> Home</label>
                            <label class="addr-chip"><input type="radio" name="addrLabel" value="Office"><i class="fas fa-building"></i> Office</label>
                            <label class="addr-chip"><input type="radio" name="addrLabel" value="Other"><i class="fas fa-map-pin"></i> Other</label>
                        </div>
                    </div>
                    <div class="addr-form-group">
                        <label for="addrRecipient"><i class="fas fa-user"></i> Recipient Name *</label>
                        <input type="text" id="addrRecipient" placeholder="Full name" required maxlength="100">
                    </div>
                    <div class="addr-form-group">
                        <label for="addrPhone"><i class="fas fa-phone"></i> Phone Number *</label>
                        <div class="addr-phone-wrap">
                            <span class="addr-phone-prefix">+254</span>
                            <input type="tel" id="addrPhone" placeholder="712 345 678" required maxlength="12">
                        </div>
                    </div>
                    <div class="addr-form-row">
                        <div class="addr-form-group">
                            <label for="addrCounty"><i class="fas fa-globe-africa"></i> County *</label>
                            <input type="text" id="addrCounty" placeholder="e.g. Mombasa" required maxlength="50">
                        </div>
                        <div class="addr-form-group">
                            <label for="addrSubcounty">Sub-County</label>
                            <input type="text" id="addrSubcounty" placeholder="e.g. Mvita" maxlength="50">
                        </div>
                    </div>
                    <div class="addr-form-group">
                        <label for="addrWard">Ward</label>
                        <input type="text" id="addrWard" placeholder="e.g. Majengo" maxlength="50">
                    </div>
                    <div class="addr-form-group">
                        <label for="addrDetail"><i class="fas fa-home"></i> Detailed Address *</label>
                        <textarea id="addrDetail" rows="3" placeholder="Building name, floor, apartment, nearest landmark..." required maxlength="300"></textarea>
                    </div>
                    <div class="addr-form-group">
                        <label class="addr-default-toggle">
                            <input type="checkbox" id="addrDefault">
                            <span class="addr-toggle-slider"></span>
                            Set as default delivery address
                        </label>
                    </div>
                </form>
            </div>
            <div class="addr-modal-footer">
                <button type="button" class="addr-btn-cancel" onclick="closeAddressModal()">Cancel</button>
                <button type="button" class="addr-btn-save" id="saveAddressBtn">
                    <i class="fas fa-check"></i> Save Address
                </button>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 Oda Pap Wholesale. All Rights Reserved.</p>
    </footer>

    <script type="module">
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDocs, updateDoc, deleteDoc, query, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { app } from "./js/firebase.js";
        import { showNotification } from './notifications.js';
        import { escapeHtml } from './js/sanitize.js';

        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;
        let addresses = [];
        let editingId = null;

        // Label chip selection
        document.querySelectorAll('.addr-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                document.querySelectorAll('.addr-chip').forEach(c => c.classList.remove('selected'));
                chip.classList.add('selected');
            });
        });

        async function loadAddresses() {
            if (!currentUser) return;
            const addrRef = collection(db, 'Users', currentUser.uid, 'Addresses');
            const snap = await getDocs(query(addrRef, orderBy('createdAt', 'desc')));
            addresses = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderAddresses();
        }

        function renderAddresses() {
            const list = document.getElementById('addressesList');
            const empty = document.getElementById('emptyState');
            const count = document.getElementById('addrCount');
            count.textContent = `${addresses.length} saved address${addresses.length !== 1 ? 'es' : ''}`;

            if (addresses.length === 0) {
                list.innerHTML = '';
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';

            list.innerHTML = addresses.map(addr => {
                const labelIcons = { Home: 'fa-home', Office: 'fa-building', Other: 'fa-map-pin' };
                const icon = labelIcons[addr.label] || 'fa-map-pin';
                return `
                <div class="addr-card ${addr.isDefault ? 'addr-default' : ''}">
                    <div class="addr-card-header">
                        <span class="addr-card-label"><i class="fas ${icon}"></i> ${escapeHtml(addr.label || 'Address')}</span>
                        ${addr.isDefault ? '<span class="addr-badge-default"><i class="fas fa-check-circle"></i> Default</span>' : ''}
                    </div>
                    <div class="addr-card-body">
                        <p class="addr-name"><strong>${escapeHtml(addr.recipientName || '')}</strong></p>
                        <p class="addr-phone"><i class="fas fa-phone"></i> ${escapeHtml(addr.phone || '')}</p>
                        <p class="addr-location"><i class="fas fa-map-marker-alt"></i> ${escapeHtml([addr.county, addr.subcounty, addr.ward].filter(Boolean).join(', '))}</p>
                        <p class="addr-detail">${escapeHtml(addr.detailedAddress || '')}</p>
                    </div>
                    <div class="addr-card-actions">
                        ${!addr.isDefault ? `<button class="addr-action-btn" onclick="setDefault('${addr.id}')"><i class="fas fa-star"></i> Set Default</button>` : ''}
                        <button class="addr-action-btn" onclick="editAddress('${addr.id}')"><i class="fas fa-edit"></i> Edit</button>
                        <button class="addr-action-btn addr-delete" onclick="deleteAddress('${addr.id}')"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                </div>`;
            }).join('');
        }

        document.getElementById('addAddressBtn').addEventListener('click', () => {
            editingId = null;
            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-plus-circle"></i> Add Address';
            document.getElementById('addressForm').reset();
            document.querySelectorAll('.addr-chip').forEach(c => c.classList.remove('selected'));
            document.querySelector('.addr-chip').classList.add('selected');
            document.getElementById('addressModal').style.display = 'flex';
        });

        window.closeAddressModal = () => {
            document.getElementById('addressModal').style.display = 'none';
            editingId = null;
        };

        // Close modal on overlay click
        document.getElementById('addressModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeAddressModal();
        });

        document.getElementById('saveAddressBtn').addEventListener('click', async () => {
            const label = document.querySelector('input[name="addrLabel"]:checked')?.value || 'Home';
            const recipientName = document.getElementById('addrRecipient').value.trim();
            const phone = document.getElementById('addrPhone').value.trim();
            const county = document.getElementById('addrCounty').value.trim();
            const subcounty = document.getElementById('addrSubcounty').value.trim();
            const ward = document.getElementById('addrWard').value.trim();
            const detailedAddress = document.getElementById('addrDetail').value.trim();
            const isDefault = document.getElementById('addrDefault').checked;

            if (!recipientName || !phone || !county || !detailedAddress) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            const btn = document.getElementById('saveAddressBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            try {
                const data = { label, recipientName, phone: `+254${phone.replace(/^0/, '').replace(/^\+254/, '')}`, county, subcounty, ward, detailedAddress, isDefault, updatedAt: Timestamp.now() };

                if (isDefault) {
                    // Unset all other defaults
                    for (const addr of addresses) {
                        if (addr.isDefault && addr.id !== editingId) {
                            await updateDoc(doc(db, 'Users', currentUser.uid, 'Addresses', addr.id), { isDefault: false });
                        }
                    }
                }

                if (editingId) {
                    await updateDoc(doc(db, 'Users', currentUser.uid, 'Addresses', editingId), data);
                    showNotification('Address updated');
                } else {
                    data.createdAt = Timestamp.now();
                    // If first address, make default
                    if (addresses.length === 0) data.isDefault = true;
                    await addDoc(collection(db, 'Users', currentUser.uid, 'Addresses'), data);
                    showNotification('Address saved');
                }

                closeAddressModal();
                await loadAddresses();
            } catch (error) {
                console.error('Error saving address:', error);
                showNotification('Failed to save address', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check"></i> Save Address';
            }
        });

        window.editAddress = (id) => {
            const addr = addresses.find(a => a.id === id);
            if (!addr) return;
            editingId = id;
            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit"></i> Edit Address';

            // Set label chip
            document.querySelectorAll('.addr-chip').forEach(c => c.classList.remove('selected'));
            const radio = document.querySelector(`input[name="addrLabel"][value="${addr.label}"]`);
            if (radio) { radio.checked = true; radio.closest('.addr-chip').classList.add('selected'); }

            document.getElementById('addrRecipient').value = addr.recipientName || '';
            document.getElementById('addrPhone').value = (addr.phone || '').replace(/^\+254/, '');
            document.getElementById('addrCounty').value = addr.county || '';
            document.getElementById('addrSubcounty').value = addr.subcounty || '';
            document.getElementById('addrWard').value = addr.ward || '';
            document.getElementById('addrDetail').value = addr.detailedAddress || '';
            document.getElementById('addrDefault').checked = addr.isDefault || false;
            document.getElementById('addressModal').style.display = 'flex';
        };

        window.deleteAddress = async (id) => {
            if (!confirm('Delete this address?')) return;
            try {
                await deleteDoc(doc(db, 'Users', currentUser.uid, 'Addresses', id));
                showNotification('Address deleted');
                await loadAddresses();
            } catch (error) {
                showNotification('Failed to delete address', 'error');
            }
        };

        window.setDefault = async (id) => {
            try {
                for (const addr of addresses) {
                    if (addr.isDefault) {
                        await updateDoc(doc(db, 'Users', currentUser.uid, 'Addresses', addr.id), { isDefault: false });
                    }
                }
                await updateDoc(doc(db, 'Users', currentUser.uid, 'Addresses', id), { isDefault: true });
                showNotification('Default address updated');
                await loadAddresses();
            } catch (error) {
                showNotification('Failed to update default', 'error');
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadAddresses();
            } else {
                window.location.href = 'login.html';
            }
        });
    </script>

    <style>
        .page-header {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, #ff5722 0%, #ff7043 100%);
            color: white;
            margin-bottom: 24px;
        }
        .page-header h1 { margin: 0 0 8px; font-size: 24px; }
        .page-header p { margin: 0; opacity: 0.9; }

        .addr-container { max-width: 700px; margin: 0 auto; padding: 0 16px 60px; }

        .addr-actions-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 16px; padding: 14px 16px;
            background: white; border-radius: 10px;
            box-shadow: 0 1px 6px rgba(0,0,0,0.08);
        }
        .addr-count { font-size: 14px; color: #666; font-weight: 600; }
        .addr-add-btn {
            background: #ff5722; color: white; border: none; padding: 10px 18px;
            border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; gap: 6px; transition: all 0.2s;
        }
        .addr-add-btn:hover { background: #e64a19; transform: translateY(-1px); }

        .addr-list { display: flex; flex-direction: column; gap: 12px; }

        .addr-card {
            background: white; border-radius: 12px; overflow: hidden;
            box-shadow: 0 1px 8px rgba(0,0,0,0.07); border: 2px solid transparent;
            transition: all 0.2s;
        }
        .addr-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
        .addr-card.addr-default { border-color: #ff5722; }

        .addr-card-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 16px; background: #fafafa; border-bottom: 1px solid #f0f0f0;
        }
        .addr-card-label { font-weight: 700; font-size: 14px; color: #333; display: flex; align-items: center; gap: 6px; }
        .addr-badge-default {
            background: #ff57221a; color: #ff5722; font-size: 11px; font-weight: 700;
            padding: 3px 10px; border-radius: 12px; display: flex; align-items: center; gap: 4px;
        }

        .addr-card-body { padding: 14px 16px; }
        .addr-card-body p { margin: 0 0 6px; font-size: 13px; color: #555; display: flex; align-items: center; gap: 6px; }
        .addr-card-body p i { color: #999; width: 14px; text-align: center; font-size: 12px; }
        .addr-name strong { color: #222; font-size: 14px; }
        .addr-detail { color: #666 !important; line-height: 1.4; }

        .addr-card-actions {
            display: flex; gap: 8px; padding: 10px 16px;
            border-top: 1px solid #f0f0f0; background: #fafafa;
        }
        .addr-action-btn {
            background: none; border: 1px solid #ddd; padding: 6px 12px;
            border-radius: 6px; font-size: 12px; color: #555; cursor: pointer;
            display: flex; align-items: center; gap: 4px; transition: all 0.2s;
        }
        .addr-action-btn:hover { background: #f5f5f5; border-color: #bbb; }
        .addr-action-btn.addr-delete { color: #f44336; border-color: #ffcdd2; }
        .addr-action-btn.addr-delete:hover { background: #ffebee; }

        .addr-empty {
            text-align: center; padding: 60px 20px;
        }
        .addr-empty i { font-size: 56px; color: #ddd; margin-bottom: 16px; display: block; }
        .addr-empty h3 { color: #444; margin: 0 0 8px; }
        .addr-empty p { color: #888; margin: 0 0 20px; }

        /* Modal */
        .addr-modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            z-index: 9999; display: flex; align-items: flex-end; justify-content: center;
        }
        .addr-modal {
            background: white; border-radius: 20px 20px 0 0; width: 100%; max-width: 500px;
            max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .addr-modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 18px 20px; border-bottom: 1px solid #eee; position: sticky; top: 0; background: white; z-index: 1;
        }
        .addr-modal-header h2 { margin: 0; font-size: 18px; color: #333; }
        .addr-modal-close { background: none; border: none; font-size: 20px; color: #999; cursor: pointer; padding: 4px 8px; }

        .addr-modal-body { padding: 20px; }

        .addr-form-group { margin-bottom: 16px; }
        .addr-form-group label { display: block; font-size: 13px; font-weight: 600; color: #444; margin-bottom: 6px; }
        .addr-form-group label i { color: #ff5722; margin-right: 4px; }
        .addr-form-group input, .addr-form-group textarea {
            width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;
            font-size: 14px; transition: border 0.2s; box-sizing: border-box;
        }
        .addr-form-group input:focus, .addr-form-group textarea:focus {
            border-color: #ff5722; outline: none; box-shadow: 0 0 0 3px rgba(255,87,34,0.1);
        }

        .addr-form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        .addr-phone-wrap {
            display: flex; align-items: center; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;
        }
        .addr-phone-prefix { padding: 10px 12px; background: #f5f5f5; font-weight: 600; color: #666; font-size: 14px; border-right: 1px solid #ddd; }
        .addr-phone-wrap input { border: none !important; border-radius: 0 !important; }
        .addr-phone-wrap input:focus { box-shadow: none !important; }

        .addr-label-chips { display: flex; gap: 8px; flex-wrap: wrap; }
        .addr-chip {
            display: flex; align-items: center; gap: 6px; padding: 8px 14px;
            border: 2px solid #e0e0e0; border-radius: 20px; font-size: 13px;
            cursor: pointer; transition: all 0.2s; color: #555; font-weight: 500;
        }
        .addr-chip input { display: none; }
        .addr-chip.selected { border-color: #ff5722; background: #fff3e0; color: #ff5722; }

        .addr-default-toggle {
            display: flex !important; align-items: center; gap: 10px; cursor: pointer;
            font-weight: 500 !important; color: #555 !important;
        }
        .addr-default-toggle input { display: none; }
        .addr-toggle-slider {
            width: 42px; height: 24px; background: #ccc; border-radius: 12px; position: relative;
            transition: background 0.3s; flex-shrink: 0;
        }
        .addr-toggle-slider::after {
            content: ''; position: absolute; top: 3px; left: 3px;
            width: 18px; height: 18px; background: white; border-radius: 50%;
            transition: transform 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .addr-default-toggle input:checked + .addr-toggle-slider { background: #ff5722; }
        .addr-default-toggle input:checked + .addr-toggle-slider::after { transform: translateX(18px); }

        .addr-modal-footer {
            display: flex; gap: 10px; padding: 16px 20px; border-top: 1px solid #eee;
            position: sticky; bottom: 0; background: white;
        }
        .addr-btn-cancel {
            flex: 1; padding: 12px; border: 1px solid #ddd; background: white;
            border-radius: 10px; font-size: 14px; cursor: pointer; color: #666;
        }
        .addr-btn-save {
            flex: 2; padding: 12px; border: none; background: #ff5722; color: white;
            border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s;
        }
        .addr-btn-save:hover { background: #e64a19; }
        .addr-btn-save:disabled { background: #ccc; }

        @media (min-width: 600px) {
            .addr-modal-overlay { align-items: center; }
            .addr-modal { border-radius: 20px; max-height: 85vh; }
        }
    </style>
</body>
</html>
