<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/jpeg" href="images/logo.jpg">
    <link rel="apple-touch-icon" href="images/logo.jpg">
    <title>AI-Powered Product Listing</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .progress-bar {
            display: flex;
            justify-content: space-between;
            padding: 30px 50px;
            background: #f8f9fa;
            position: relative;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
        }

        .progress-step::before {
            content: '';
            position: absolute;
            top: 25px;
            left: 50%;
            width: 100%;
            height: 3px;
            background: #ddd;
            z-index: 0;
        }

        .progress-step:last-child::before {
            display: none;
        }

        .step-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #ddd;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
            z-index: 1;
            transition: all 0.3s;
        }

        .progress-step.active .step-circle {
            background: #667eea;
            transform: scale(1.1);
        }

        .progress-step.completed .step-circle {
            background: #4CAF50;
        }

        .step-label {
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
            font-weight: 600;
        }

        .form-content {
            padding: 40px 50px;
        }

        .form-step {
            display: none;
        }

        .form-step.active {
            display: block;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 0.85em;
        }

        .ai-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 1em;
            transition: transform 0.2s;
            margin-top: 10px;
        }

        .ai-btn:hover {
            transform: translateY(-2px);
        }

        .ai-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .ai-suggestions {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px;
            border-radius: 12px;
            margin: 25px 0;
            color: white;
        }

        .ai-suggestions h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .suggestion-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .suggestion-box textarea {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            min-height: 100px;
            font-size: 0.95em;
            margin-top: 10px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #e8eaf6;
        }

        .upload-area i {
            font-size: 3em;
            color: #667eea;
            margin-bottom: 15px;
        }

        .search-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(66, 133, 244, 0.3);
        }

        .preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .preview-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .preview-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .preview-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ff5252;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .variation-row {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
        }

        .variation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .attribute-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
        }

        .attribute-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            padding: 30px 50px;
            background: #f8f9fa;
            border-top: 2px solid #e0e0e0;
        }

        .nav-btn {
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .nav-btn.prev {
            background: #e0e0e0;
            color: #333;
        }

        .nav-btn.next {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            overflow-y: auto;
        }

        .modal-content {
            max-width: 1200px;
            margin: 50px auto;
            background: white;
            border-radius: 16px;
            padding: 30px;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #ff5252;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5em;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .image-card {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .image-card:hover {
            transform: scale(1.05);
        }

        .image-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .image-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
            padding: 15px 10px 10px;
        }

        .download-link {
            background: white;
            color: #333;
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .info-box {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
            margin: 20px 0;
        }

        .info-box h4 {
            margin-bottom: 10px;
            color: #1976D2;
        }

        .info-box ol {
            margin-left: 20px;
            line-height: 1.8;
        }

        .spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner i {
            font-size: 3em;
            color: #667eea;
        }

        @media (max-width: 768px) {
            .form-content {
                padding: 20px;
            }

            .nav-buttons {
                padding: 20px;
            }

            .progress-bar {
                padding: 20px;
            }

            .attribute-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <i class="fas fa-magic"></i>
                AI-Powered Product Listing
            </h1>
            <p>Smart listing with AI assistance - Easy, Fast, Professional</p>
        </div>

        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress-step active" data-step="1">
                <div class="step-circle">1</div>
                <div class="step-label">Product Info</div>
            </div>
            <div class="progress-step" data-step="2">
                <div class="step-circle">2</div>
                <div class="step-label">Images</div>
            </div>
            <div class="progress-step" data-step="3">
                <div class="step-circle">3</div>
                <div class="step-label">Variations</div>
            </div>
            <div class="progress-step" data-step="4">
                <div class="step-circle">4</div>
                <div class="step-label">Review</div>
            </div>
        </div>

        <!-- Form -->
        <form id="listing-form">
            <!-- Step 1: Product Information -->
            <div class="form-step active" data-step="1">
                <div class="form-content">
                    <h2 style="margin-bottom: 20px; color: #333;">
                        <i class="fas fa-info-circle"></i> Product Information
                    </h2>

                    <div class="form-group">
                        <label>Product Name *</label>
                        <input type="text" id="product-name" required placeholder="e.g., Nike Air Max Shoes">
                        <small>Enter a clear, descriptive product name</small>
                    </div>

                    <div class="form-group">
                        <label>Category *</label>
                        <select id="category" required>
                            <option value="">Select category</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Brand *</label>
                        <input type="text" id="brand" required placeholder="e.g., Nike">
                    </div>

                    <button type="button" class="ai-btn" id="generate-ai-btn">
                        <i class="fas fa-magic"></i>
                        Generate AI Suggestions
                    </button>

                    <div id="ai-suggestions-container"></div>

                    <div class="form-group">
                        <label>Product Description *</label>
                        <textarea id="description" required placeholder="Describe your product in detail..."></textarea>
                        <small>Be detailed - buyers need comprehensive information</small>
                    </div>

                    <div class="form-group">
                        <label>Base Price (KES) *</label>
                        <input type="number" id="price" required placeholder="1200" step="0.01">
                        <small>Your wholesale price per unit</small>
                    </div>
                </div>
            </div>

            <!-- Step 2: Images -->
            <div class="form-step" data-step="2">
                <div class="form-content">
                    <h2 style="margin-bottom: 20px; color: #333;">
                        <i class="fas fa-camera"></i> Product Images
                    </h2>

                    <div class="form-group">
                        <label>Verification Photo (Required) *</label>
                        <div class="upload-area" id="photo-trace-upload" onclick="document.getElementById('photo-trace-input').click()">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p style="font-weight: 600; margin: 10px 0;">Drop verification photo here or click to browse</p>
                            <p style="color: #666; font-size: 0.9em;">Upload a clear photo of your actual product</p>
                        </div>
                        <input type="file" id="photo-trace-input" accept="image/*" style="display: none;">
                        <button type="button" class="search-btn" onclick="openImageSearch('photoTrace')">
                            <i class="fas fa-search"></i>
                            Search Images Online
                        </button>
                        <div id="photo-trace-preview" class="preview-container"></div>
                    </div>

                    <div class="form-group">
                        <label>Additional Product Images (Optional)</label>
                        <div class="upload-area" id="additional-images-upload" onclick="document.getElementById('additional-images-input').click()">
                            <i class="fas fa-images"></i>
                            <p style="font-weight: 600; margin: 10px 0;">Drop additional images here or click to browse</p>
                            <p style="color: #666; font-size: 0.9em;">Upload up to 5 additional photos</p>
                        </div>
                        <input type="file" id="additional-images-input" accept="image/*" multiple style="display: none;">
                        <button type="button" class="search-btn" onclick="openImageSearch('additional')">
                            <i class="fas fa-search"></i>
                            Search More Images
                        </button>
                        <div id="additional-images-preview" class="preview-container"></div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Variations -->
            <div class="form-step" data-step="3">
                <div class="form-content">
                    <h2 style="margin-bottom: 20px; color: #333;">
                        <i class="fas fa-boxes"></i> Product Variations
                    </h2>

                    <div id="variations-container"></div>

                    <button type="button" class="ai-btn" onclick="addVariation()">
                        <i class="fas fa-plus"></i>
                        Add Variation
                    </button>
                </div>
            </div>

            <!-- Step 4: Review -->
            <div class="form-step" data-step="4">
                <div class="form-content">
                    <h2 style="margin-bottom: 20px; color: #333;">
                        <i class="fas fa-clipboard-check"></i> Review Your Listing
                    </h2>

                    <div id="review-summary" style="background: #f8f9fa; padding: 25px; border-radius: 12px; line-height: 1.8;"></div>

                    <button type="submit" class="ai-btn" style="width: 100%; justify-content: center; margin-top: 30px; font-size: 1.2em; padding: 20px;">
                        <i class="fas fa-check-circle"></i>
                        Publish Listing
                    </button>
                </div>
            </div>
        </form>

        <!-- Navigation Buttons -->
        <div class="nav-buttons">
            <button type="button" class="nav-btn prev" id="prev-btn" style="display: none;">
                <i class="fas fa-arrow-left"></i>
                Back
            </button>
            <button type="button" class="nav-btn next" id="next-btn">
                Next
                <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Image Search Modal -->
    <div id="image-search-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeImageSearch()">×</button>
            
            <h2 style="margin-bottom: 20px; color: #333;">
                <i class="fas fa-search"></i> Smart Image Search
            </h2>

            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <input type="text" id="image-search-input" placeholder="Search for product images..." style="flex: 1; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
                <button class="ai-btn" onclick="searchImages()">
                    <i class="fas fa-search"></i>
                    Search
                </button>
                <button class="search-btn" onclick="openGoogleImages()">
                    <i class="fab fa-google"></i>
                    Google Images
                </button>
            </div>

            <div id="search-loading" class="spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <p style="margin-top: 15px; color: #666;">Searching for images...</p>
            </div>

            <div id="image-results" class="image-grid"></div>

            <div class="info-box">
                <h4><i class="fas fa-lightbulb"></i> How to use:</h4>
                <ol>
                    <li><strong>Search Free Images:</strong> Browse curated stock photos</li>
                    <li><strong>Google Images:</strong> Opens Google in new tab for more options</li>
                    <li><strong>Download:</strong> Right-click images and "Save image as..."</li>
                    <li><strong>Upload:</strong> Drag downloaded images into upload areas</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentStep = 1;
        const totalSteps = 4;
        let photoTraceFile = null;
        let additionalFiles = [];
        let variations = [];
        let currentSearchContext = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            updateStepDisplay();
        });

        function setupEventListeners() {
            // Navigation buttons
            document.getElementById('next-btn').addEventListener('click', nextStep);
            document.getElementById('prev-btn').addEventListener('click', prevStep);

            // AI Generate button
            document.getElementById('generate-ai-btn').addEventListener('click', generateAISuggestions);

            // File inputs
            document.getElementById('photo-trace-input').addEventListener('change', handlePhotoTraceUpload);
            document.getElementById('additional-images-input').addEventListener('change', handleAdditionalImagesUpload);

            // Form submission
            document.getElementById('listing-form').addEventListener('submit', handleSubmit);

            // Drag and drop
            setupDragAndDrop();
        }

        function setupDragAndDrop() {
            const photoTraceArea = document.getElementById('photo-trace-upload');
            const additionalArea = document.getElementById('additional-images-upload');

            [photoTraceArea, additionalArea].forEach(area => {
                area.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    area.style.borderColor = '#764ba2';
                });

                area.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    area.style.borderColor = '#667eea';
                });

                area.addEventListener('drop', (e) => {
                    e.preventDefault();
                    area.style.borderColor = '#667eea';
                    
                    const files = Array.from(e.dataTransfer.files);
                    if (area.id === 'photo-trace-upload') {
                        handlePhotoTraceFile(files[0]);
                    } else {
                        handleAdditionalFiles(files);
                    }
                });
            });
        }

        // Step Navigation
        function nextStep() {
            if (validateCurrentStep()) {
                if (currentStep < totalSteps) {
                    currentStep++;
                    updateStepDisplay();
                    if (currentStep === 4) {
                        updateReviewSummary();
                    }
                }
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepDisplay();
            }
        }

        function updateStepDisplay() {
            // Update form steps
            document.querySelectorAll('.form-step').forEach((step, index) => {
                step.classList.toggle('active', index + 1 === currentStep);
            });

            // Update progress bar
            document.querySelectorAll('.progress-step').forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index + 1 < currentStep) {
                    step.classList.add('completed');
                } else if (index + 1 === currentStep) {
                    step.classList.add('active');
                }
            });

            // Update navigation buttons
            document.getElementById('prev-btn').style.display = currentStep === 1 ? 'none' : 'flex';
            document.getElementById('next-btn').style.display = currentStep === totalSteps ? 'none' : 'flex';

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function validateCurrentStep() {
            if (currentStep === 1) {
                const name = document.getElementById('product-name').value;
                const category = document.getElementById('category').value;
                const brand = document.getElementById('brand').value;
                const description = document.getElementById('description').value;
                const price = document.getElementById('price').value;

                if (!name || !category || !brand || !description || !price) {
                    alert('Please fill in all required fields');
                    return false;
                }
            } else if (currentStep === 2) {
                if (!photoTraceFile) {
                    alert('Please upload a verification photo');
                    return false;
                }
            }
            return true;
        }

        // AI Suggestions
        async function generateAISuggestions() {
            const productName = document.getElementById('product-name').value;
            const category = document.getElementById('category').value;

            if (!productName || productName.length < 3) {
                alert('Please enter a product name first');
                return;
            }

            const btn = document.getElementById('generate-ai-btn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            btn.disabled = true;

            // Simulate AI processing
            await new Promise(resolve => setTimeout(resolve, 1500));

            const isClothing = category === 'fashion';
            const isElectronics = category === 'electronics';

            const description = `Premium ${productName} featuring high-quality materials and excellent craftsmanship. Perfect for wholesale distribution with competitive bulk pricing. Ideal for retailers and distributors looking for reliable inventory. Available in multiple variations to meet diverse market needs.`;
            
            const variations = isClothing ? ['Size', 'Color'] : isElectronics ? ['Storage Capacity', 'Color'] : ['Type', 'Quantity'];

            displayAISuggestions(description, variations);

            btn.innerHTML = '<i class="fas fa-magic"></i> Regenerate AI Suggestions';
            btn.disabled = false;
        }

        function displayAISuggestions(description, variations) {
            const container = document.getElementById('ai-suggestions-container');
            container.innerHTML = `
                <div class="ai-suggestions">
                    <h3>
                        <i class="fas fa-magic"></i>
                        AI Suggestions
                    </h3>

                    <div class="suggestion-box">
                        <strong>Suggested Description:</strong>
                        <textarea id="ai-description-edit">${description}</textarea>
                        <div class="btn-group" style="margin-top: 10px;">
                            <button type="button" class="btn btn-primary" onclick="applyAIDescription()">
                                <i class="fas fa-check"></i> Use This Description
                            </button>
                        </div>
                    </div>

                    <div class="suggestion-box">
                        <strong style="display: block; margin-bottom: 10px;">Suggested Variations:</strong>
                        <div class="btn-group">
                            ${variations.map(v => `
                                <button type="button" class="btn btn-secondary" onclick="addSuggestedVariation('${v}')">
                                    <i class="fas fa-plus"></i> Add ${v}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function applyAIDescription() {
            const aiDesc = document.getElementById('ai-description-edit').value;
            document.getElementById('description').value = aiDesc;
            alert('Description applied successfully!');
        }

        function addSuggestedVariation(type) {
            addVariation(type);
            alert(`${type} variation added!`);
        }

        // File Handling
        function handlePhotoTraceUpload(event) {
            handlePhotoTraceFile(event.target.files[0]);
        }

        function handlePhotoTraceFile(file) {
            if (file && file.type.startsWith('image/')) {
                photoTraceFile = file;
                const preview = document.getElementById('photo-trace-preview');
                preview.innerHTML = `
                    <div class="preview-item">
                        <img src="${URL.createObjectURL(file)}" alt="Verification photo">
                        <button type="button" class="remove-btn" onclick="removePhotoTrace()">×</button>
                    </div>
                `;
            }
        }

        function removePhotoTrace() {
            photoTraceFile = null;
            document.getElementById('photo-trace-preview').innerHTML = '';
            document.getElementById('photo-trace-input').value = '';
        }

        function handleAdditionalImagesUpload(event) {
            handleAdditionalFiles(Array.from(event.target.files));
        }

        function handleAdditionalFiles(files) {
            const imageFiles = files.filter(f => f.type.startsWith('image/'));
            additionalFiles = [...additionalFiles, ...imageFiles].slice(0, 5);
            
            const preview = document.getElementById('additional-images-preview');
            preview.innerHTML = additionalFiles.map((file, index) => `
                <div class="preview-item">
                    <img src="${URL.createObjectURL(file)}" alt="Additional image ${index + 1}">
                    <button type="button" class="remove-btn" onclick="removeAdditionalImage(${index})">×</button>
                </div>
            `).join('');
        }

        function removeAdditionalImage(index) {
            additionalFiles.splice(index, 1);
            handleAdditionalFiles([]);
        }

        // Variations
        function addVariation(suggestedType = '') {
            const id = Date.now();
            variations.push({ id, type: suggestedType, attributes: [] });

            const container = document.getElementById('variations-container');
            const variationDiv = document.createElement('div');
            variationDiv.className = 'variation-row';
            variationDiv.id = `variation-${id}`;
            variationDiv.innerHTML = `
                <div class="variation-header">
                    <input type="text" placeholder="Variation type (e.g., Size, Color)" value="${suggestedType}" 
                           class="variation-type" style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-weight: 600;">
                    <button type="button" class="search-btn" onclick="openImageSearch('variation-${id}')" style="margin: 0 10px;">
                        <i class="fas fa-search"></i> Search Images
                    </button>
                    <button type="button" class="remove-btn" onclick="removeVariation(${id})" style="position: static; width: auto; height: auto; padding: 8px 16px; border-radius: 6px;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="attributes-container" id="attributes-${id}">
                    <!-- Attribute items will be inserted here -->
                    <button type="button" class="btn btn-secondary" onclick="addAttribute(${id})" style="width: 100%; margin-top: 10px;">
                        <i class="fas fa-plus"></i> Add Option
                    </button>
                </div>
            `;

            container.appendChild(variationDiv);
            addAttribute(id); // Add first attribute by default
        }

        function removeVariation(id) {
            document.getElementById(`variation-${id}`).remove();
            variations = variations.filter(v => v.id !== id);
        }

        function addAttribute(variationId) {
            const attrId = Date.now() + Math.random();
            const container = document.getElementById(`attributes-${variationId}`);
            // Insert before the "Add Option" button
            const addBtn = container.querySelector('.btn.btn-secondary');
            const attrDiv = document.createElement('div');
            attrDiv.className = 'attribute-item';
            attrDiv.id = `attribute-${attrId}`;
            attrDiv.innerHTML = `
                <div class="attribute-grid">
                    <input type="text" placeholder="Option name (e.g., Small)" class="attr-name" style="padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
                    <input type="number" placeholder="Stock quantity" class="attr-stock" min="1" style="padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
                    <input type="number" placeholder="Pieces per unit" class="attr-pieces" value="1" min="1" style="padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
                </div>
                <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                    <input type="file" accept="image/*" class="attr-image" id="attr-image-${attrId}" style="display: none;" onchange="handleAttributeImage(${attrId}, event)">
                    <label for="attr-image-${attrId}" style="background: #e0e0e0; padding: 8px 16px; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
                        <i class="fas fa-image"></i> Add Image
                    </label>
                    <div id="attr-preview-${attrId}" style="flex: 1;"></div>
                    <button type="button" class="remove-btn" onclick="removeAttribute(${variationId}, '${attrId}')" style="position: static; width: auto; height: auto;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            container.insertBefore(attrDiv, addBtn);
        }

        function removeAttribute(variationId, attrId) {
            const attrDiv = document.getElementById(`attribute-${attrId}`);
            if (attrDiv) attrDiv.remove();
        }

        function handleAttributeImage(attrId, event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const preview = document.getElementById(`attr-preview-${attrId}`);
                preview.innerHTML = `
                    <img src="${URL.createObjectURL(file)}" style="height: 50px; border-radius: 6px;">
                `;
            }
        }

        // Image Search Modal
        function openImageSearch(context) {
            currentSearchContext = context;
            const modal = document.getElementById('image-search-modal');
            modal.style.display = 'block';

            const productName = document.getElementById('product-name').value || '';
            const searchInput = document.getElementById('image-search-input');
            searchInput.value = productName;

            if (productName) {
                searchImages();
            }
        }

        function closeImageSearch() {
            document.getElementById('image-search-modal').style.display = 'none';
        }

        async function searchImages() {
            const query = document.getElementById('image-search-input').value;
            if (!query) {
                alert('Please enter a search term');
                return;
            }

            const loading = document.getElementById('search-loading');
            const results = document.getElementById('image-results');
            
            loading.style.display = 'block';
            results.innerHTML = '';

            await new Promise(resolve => setTimeout(resolve, 800));

            const images = [];
            for (let i = 1; i <= 12; i++) {
                images.push({
                    url: `https://source.unsplash.com/400x300/?${encodeURIComponent(query)},${i}`,
                    download: `https://source.unsplash.com/800x600/?${encodeURIComponent(query)},${i}`
                });
            }

            loading.style.display = 'none';
            
            results.innerHTML = images.map((img, idx) => `
                <div class="image-card">
                    <img src="${img.url}" alt="Search result ${idx + 1}">
                    <div class="image-overlay">
                        <a href="${img.download}" download="product-image-${idx + 1}.jpg" class="download-link">
                            <i class="fas fa-download"></i>
                            Download
                        </a>
                        <p style="color: white; font-size: 11px; margin: 8px 0 0; opacity: 0.9;">Right-click → Save as...</p>
                    </div>
                </div>
            `).join('');
        }

        function openGoogleImages() {
            const query = document.getElementById('image-search-input').value || document.getElementById('product-name').value;
            if (!query) {
                alert('Please enter a search term');
                return;
            }

            const googleUrl = `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(query)}`;
            window.open(googleUrl, '_blank', 'width=1200,height=800');
            alert('Google Images opened in new tab. Download images and drag them into the upload areas.');
        }

        // Review Summary
        function updateReviewSummary() {
            const productName = document.getElementById('product-name').value;
            const category = document.getElementById('category').value;
            const brand = document.getElementById('brand').value;
            const description = document.getElementById('description').value;
            const price = document.getElementById('price').value;

            let variationsSummary = '<p><strong>No variations added</strong></p>';
            if (variations.length > 0) {
                variationsSummary = '<ul>';
                variations.forEach((v, index) => {
                    const varDiv = document.getElementById(`variation-${v.id}`);
                    const type = varDiv.querySelector('.variation-type').value || `Variation ${index + 1}`;
                    const attrs = varDiv.querySelectorAll('.attribute-item');
                    let attrList = '';
                    attrs.forEach(attr => {
                        const name = attr.querySelector('.attr-name').value || '';
                        const stock = attr.querySelector('.attr-stock').value || '';
                        const pieces = attr.querySelector('.attr-pieces').value || '';
                        if (name) {
                            attrList += `<li>${name} (Stock: ${stock}, Pieces/unit: ${pieces})</li>`;
                        }
                    });
                    variationsSummary += `<li><strong>${type}:</strong><ul>${attrList || '<li>No options</li>'}</ul></li>`;
                });
                variationsSummary += '</ul>';
            }

            document.getElementById('review-summary').innerHTML = `
                <h3 style="margin-bottom: 15px; color: #667eea;">Product Details</h3>
                <p><strong>Product Name:</strong> ${productName}</p>
                <p><strong>Category:</strong> ${category}</p>
                <p><strong>Brand:</strong> ${brand}</p>
                <p><strong>Price:</strong> KES ${price}</p>
                <p><strong>Description:</strong> ${description.substring(0, 200)}${description.length > 200 ? '...' : ''}</p>
                
                <h3 style="margin: 20px 0 15px; color: #667eea;">Images</h3>
                <p><strong>Verification Photo:</strong> ${photoTraceFile ? '✓ Uploaded' : '✗ Not uploaded'}</p>
                <p><strong>Additional Images:</strong> ${additionalFiles.length} image(s)</p>
                
                <h3 style="margin: 20px 0 15px; color: #667eea;">Variations</h3>
                ${variationsSummary}
            `;
        }

        // Form Submission
        function handleSubmit(event) {
            event.preventDefault();

            const formData = {
                productName: document.getElementById('product-name').value,
                category: document.getElementById('category').value,
                brand: document.getElementById('brand').value,
                description: document.getElementById('description').value,
                price: document.getElementById('price').value,
                photoTrace: photoTraceFile,
                additionalImages: additionalFiles,
                variations: variations.map(v => {
                    const varDiv = document.getElementById(`variation-${v.id}`);
                    const type = varDiv.querySelector('.variation-type').value;
                    const attrs = Array.from(varDiv.querySelectorAll('.attribute-item')).map(attr => ({
                        name: attr.querySelector('.attr-name').value,
                        stock: attr.querySelector('.attr-stock').value,
                        pieces: attr.querySelector('.attr-pieces').value
                    }));
                    return { type, attributes: attrs };
                })
            };

            console.log('Form Data:', formData);
            alert('✓ Listing submitted successfully!\n\nIn production, this would save to Firebase.\n\nCheck console for data.');

            // Reset form
            document.getElementById('listing-form').reset();
            currentStep = 1;
            photoTraceFile = null;
            additionalFiles = [];
            variations = [];
            document.getElementById('variations-container').innerHTML = '';
            document.getElementById('photo-trace-preview').innerHTML = '';
            document.getElementById('additional-images-preview').innerHTML = '';
            document.getElementById('ai-suggestions-container').innerHTML = '';
            updateStepDisplay();
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('image-search-modal');
            if (event.target === modal) {
                closeImageSearch();
            }
        };
    </script>
    <script type="module">
        import { categoryHierarchy } from './js/categoryData.js';

        // Populate main category dropdown
        const categorySelect = document.getElementById('category');
        categorySelect.innerHTML = '<option value="">Select category</option>';
        Object.keys(categoryHierarchy).forEach(key => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = categoryHierarchy[key].label;
            categorySelect.appendChild(option);
        });
    </script>
</body>
</html>